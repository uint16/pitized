<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PiTiZed</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
@import url('../vendor/fonts.css');

:root {
  --bg-0:#06060a;--bg-1:#0b0b12;--bg-2:#101018;--bg-3:#16161f;
  --bg-4:#1c1c28;--bg-5:#232332;--bg-hover:#282840;
  --border-0:#1a1a28;--border-1:#242436;--border-2:#2e2e44;
  --text-1:#eaeaf2;--text-2:#9898b4;--text-3:#606080;
  --accent:#5b8aff;--accent-dim:#5b8aff30;--accent-soft:#5b8aff14;
  --green:#3dd68c;--green-dim:#3dd68c40;--green-soft:#3dd68c14;
  --amber:#f0b429;--amber-dim:#f0b42940;--amber-soft:#f0b42914;
  --red:#f06060;--red-dim:#f0606040;--red-soft:#f0606014;
  --r:10px;--r-sm:7px;--r-xs:5px;
  --font:'Instrument Sans',system-ui,sans-serif;
  --mono:'IBM Plex Mono',monospace;
  --drag-h:38px;--sidebar-w:310px;
}

[data-theme="light"] {
  --bg-0:#f2f2f5;--bg-1:#ffffff;--bg-2:#ffffff;--bg-3:#f4f4f7;
  --bg-4:#e4e4eb;--bg-5:#dcdce4;--bg-hover:#ebebf0;
  --border-0:#e0e0e8;--border-1:#d0d0d8;--border-2:#c0c0c8;
  --text-1:#1a1a20;--text-2:#505060;--text-3:#808090;
  --accent:#4070f4;--accent-dim:#4070f420;--accent-soft:#4070f410;
  --green:#20a060;--green-dim:#20a06030;--green-soft:#20a06010;
  --amber:#d09010;--amber-dim:#d0901030;--amber-soft:#d0901010;
  --red:#d04040;--red-dim:#d0404030;--red-soft:#d0404010;
}

html,body{height:100%;font-family:var(--font);background:var(--bg-0);color:var(--text-1);overflow:hidden;-webkit-font-smoothing:antialiased;font-size:13px}

/* ── Titlebar ─────────────────────────────────────────────────────────────── */
.titlebar{-webkit-app-region:drag;height:var(--drag-h);display:flex;align-items:center;justify-content:center;position:fixed;top:0;left:0;right:0;z-index:100}
.titlebar span{font-size:11px;font-weight:600;color:var(--text-3);letter-spacing:1px;text-transform:uppercase}

/* ── Layout ───────────────────────────────────────────────────────────────── */
.app{display:grid;grid-template-rows:auto 1fr;height:100vh;padding-top:var(--drag-h)}
.header{padding:10px 24px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border-0)}
.header-l{display:flex;align-items:center;gap:12px}
.logo{width:30px;height:30px;border-radius:var(--r-sm);background:linear-gradient(135deg,var(--accent),#b07cff);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 10px var(--accent-dim)}
.header h1{font-size:15px;font-weight:600;letter-spacing:-.3px}
.header h1 span{color:var(--text-3);font-weight:400;margin-left:4px}
.header-r{display:flex;gap:6px;align-items:center}
.main{display:grid;grid-template-columns:1fr auto;overflow:hidden}

/* ── Camera Panel ─────────────────────────────────────────────────────────── */
.cam-panel{overflow-y:auto;padding:16px 20px 40px}
.cam-panel-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.cam-panel-title{font-size:12px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.7px;display:flex;align-items:center;gap:8px}
.badge{font-family:var(--mono);font-size:11px;padding:1px 7px;border-radius:20px;background:var(--accent-soft);color:var(--accent)}
.badge.warn{background:var(--amber-soft);color:var(--amber)}

/* ── Camera Card ──────────────────────────────────────────────────────────── */
.cam{background:var(--bg-2);border:1px solid var(--border-0);border-radius:var(--r);margin-bottom:10px;overflow:hidden;transition:border-color .2s;position:relative}
.cam::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--c,var(--text-3));opacity:.4;transition:opacity .25s}
.cam.on::before{opacity:1}
.cam.source::before{width:4px}
.cam.sync-target{border-color:var(--c,var(--accent))30}

.cam-top{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;cursor:pointer;user-select:none;-webkit-app-region:no-drag;gap:8px}
.cam-top:hover{background:var(--bg-3)}

.cam-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
.cam-dot{width:8px;height:8px;border-radius:50%;background:var(--text-3);transition:all .3s;flex-shrink:0}
.cam.on .cam-dot{background:var(--green);box-shadow:0 0 6px var(--green-dim)}

.cam-name-wrap{min-width:0}
.cam-name{font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cam-name-input{font-family:var(--font);font-weight:600;font-size:13px;background:var(--bg-0);border:1px solid var(--accent);border-radius:var(--r-xs);padding:1px 6px;color:var(--text-1);outline:none;width:140px}
.cam-sub{font-size:11px;color:var(--text-3);margin-top:1px}

.cam-right{display:flex;align-items:center;gap:6px;flex-shrink:0}

/* Sync checkbox */
.sync-check{position:relative;width:18px;height:18px;flex-shrink:0;cursor:pointer}
.sync-check input{position:absolute;opacity:0;width:100%;height:100%;cursor:pointer;margin:0}
.sync-check .mark{width:18px;height:18px;border-radius:4px;border:2px solid var(--border-2);background:var(--bg-0);display:flex;align-items:center;justify-content:center;transition:all .15s;pointer-events:none}
.sync-check input:checked+.mark{background:var(--accent);border-color:var(--accent)}
.sync-check input:checked+.mark::after{content:'';display:block;width:4px;height:8px;border:solid white;border-width:0 2px 2px 0;transform:rotate(45deg) translate(-1px,-1px)}
.sync-check-tip{font-size:9px;color:var(--text-3);text-transform:uppercase;letter-spacing:.3px;writing-mode:vertical-rl;transform:rotate(180deg);line-height:1;margin-right:-2px;display:none}
.cam.on .sync-check-tip{display:block}

.cam-ip{font-family:var(--mono);font-size:12px;background:var(--bg-0);border:1px solid var(--border-0);border-radius:var(--r-xs);padding:5px 9px;color:var(--text-1);width:140px;outline:none;transition:border-color .15s;-webkit-app-region:no-drag}
.cam-ip:focus{border-color:var(--accent)}
.cam-ip::placeholder{color:var(--text-3)}
.cam-ip:disabled{opacity:.5;cursor:default}

.src-tag{font-size:9px;text-transform:uppercase;letter-spacing:.6px;font-weight:700;padding:3px 7px;border-radius:4px;background:var(--accent-soft);color:var(--accent)}
.expand-arrow{color:var(--text-3);transition:transform .2s;flex-shrink:0}
.cam.expanded .expand-arrow{transform:rotate(180deg)}

/* Remove button */
.cam-remove{width:22px;height:22px;border-radius:4px;border:1px solid transparent;background:transparent;color:var(--text-3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
.cam-remove:hover{background:var(--red-soft);border-color:var(--red-dim);color:var(--red)}
.cam-remove.confirm{background:var(--red);border-color:var(--red);color:white;animation:headshake .4s}
@keyframes headshake{0%,100%{transform:translateX(0)}25%{transform:translateX(-3px)}75%{transform:translateX(3px)}}

/* ── Preview row ──────────────────────────────────────────────────────────── */
.cam-preview{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:6px 10px;padding:0 16px 12px;border-top:1px solid var(--border-0);padding-top:10px}
.cam.expanded .cam-preview{display:none}
.pv-item{display:flex;flex-direction:column;gap:2px}
.pv-label{font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:.4px;font-weight:600}
.pv-val{font-family:var(--mono);font-size:16px;font-weight:500;line-height:1}
.pv-val.mm{color:var(--amber)}

/* ── Expanded body ────────────────────────────────────────────────────────── */
.cam-body{display:none;border-top:1px solid var(--border-0);animation:slideDown .25s ease}
.cam.expanded .cam-body{display:block}
@keyframes slideDown{from{opacity:0}to{opacity:1}}
.cam-body-inner{display:grid;grid-template-columns:280px 1fr;gap:0}

/* Viewfinder */
.viewfinder{background:#000;position:relative;min-height:200px;display:flex;align-items:center;justify-content:center;border-right:1px solid var(--border-0)}
.viewfinder img{width:100%;height:100%;object-fit:contain;display:block}
.vf-placeholder{color:var(--text-3);font-size:11px;text-align:center;line-height:1.5}
.vf-overlay{position:absolute;bottom:0;left:0;right:0;padding:8px 10px;background:linear-gradient(transparent,rgba(0,0,0,.7));display:flex;justify-content:space-between;align-items:flex-end}
.vf-badge{font-family:var(--mono);font-size:10px;color:var(--green);background:rgba(0,0,0,.5);padding:2px 6px;border-radius:3px}
.vf-wb-badge{font-family:var(--mono);font-size:10px;padding:2px 6px;border-radius:3px}
.vf-wb-badge.cool{color:#88ccff;background:rgba(100,180,255,.15)}
.vf-wb-badge.warm{color:#ffcc66;background:rgba(255,180,60,.15)}
.vf-wb-badge.ok{color:var(--green);background:rgba(60,220,140,.15)}
.vf-actions{display:flex;gap:5px;align-items:center}
.vf-action-btn{background:rgba(255,255,255,.12);border:none;color:#fff;cursor:pointer;border-radius:4px;padding:4px 6px;font-size:10px;font-family:var(--font);display:inline-flex;align-items:center;gap:3px;transition:background .15s}
.vf-action-btn:hover{background:rgba(255,255,255,.25)}
.vf-action-btn.active{background:rgba(60,220,140,.3);color:var(--green)}

/* Feed & Resolution */
.feed-panel{border-top:1px solid var(--border-0);padding:12px 16px;background:var(--bg-2)}
.feed-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
.feed-field{display:flex;flex-direction:column;gap:3px}
.feed-field label{font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:.3px}
.feed-field select,.feed-field input{font-family:var(--font);font-size:11px;padding:4px 6px;background:var(--bg-3);border:1px solid var(--border-1);border-radius:var(--r-xs);color:var(--text-1)}
.feed-field input[type=number]{width:70px}
.feed-row{display:flex;gap:8px;align-items:flex-end;margin-top:8px}

/* Advanced Settings (collapsible) */
.adv-panel{border-top:1px solid var(--border-0);background:var(--bg-1)}
.adv-toggle{display:flex;align-items:center;gap:6px;padding:10px 16px;cursor:pointer;font-size:11px;color:var(--text-3);transition:color .15s;user-select:none}
.adv-toggle:hover{color:var(--text-1)}
.adv-toggle svg{transition:transform .2s}
.adv-toggle.open svg{transform:rotate(90deg)}
.adv-body{display:none;padding:0 16px 12px}
.adv-body.open{display:block}
.adv-section{font-size:10px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.5px;margin:10px 0 6px;padding-top:8px;border-top:1px solid var(--border-0)}
.adv-section:first-child{border-top:none;margin-top:4px}
.adv-row{display:flex;align-items:center;justify-content:space-between;padding:4px 0;font-size:11px}
.adv-row label{color:var(--text-2)}
.adv-row select,.adv-row input{font-family:var(--font);font-size:11px;padding:3px 6px;background:var(--bg-3);border:1px solid var(--border-1);border-radius:var(--r-xs);color:var(--text-1)}
.adv-row input[type=number]{width:65px}
.adv-row .adv-btn{font-size:10px;padding:3px 8px}
.adv-note{font-size:10px;color:var(--text-3);font-style:italic;margin:4px 0}

/* PTZ */
.ptz-controls{padding:12px;display:flex;flex-direction:column;gap:10px}
.ctrl-section{border-bottom:1px solid var(--border-0);padding-bottom:10px}
.ctrl-section:last-child{border-bottom:none;padding-bottom:0}
.ctrl-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-3);margin-bottom:8px;display:flex;align-items:center;gap:6px}

.joystick{width:100px;height:100px;border-radius:50%;background:var(--bg-0);border:2px solid var(--border-1);position:relative;margin:0 auto}
.joy-btn{position:absolute;width:28px;height:28px;border-radius:50%;background:var(--bg-4);border:1px solid var(--border-1);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .1s;color:var(--text-2);font-size:10px}
.joy-btn:hover{background:var(--accent);color:white;border-color:var(--accent)}
.joy-btn.active,.joy-btn:active{background:var(--accent);color:white;border-color:var(--accent)}
.joy-btn.up{top:-2px;left:50%;transform:translateX(-50%)}.joy-btn.up:hover{transform:translateX(-50%) scale(1.05)}.joy-btn.up.active,.joy-btn.up:active{transform:translateX(-50%) scale(.92)}
.joy-btn.down{bottom:-2px;left:50%;transform:translateX(-50%)}.joy-btn.down:hover{transform:translateX(-50%) scale(1.05)}.joy-btn.down.active,.joy-btn.down:active{transform:translateX(-50%) scale(.92)}
.joy-btn.left{left:-2px;top:50%;transform:translateY(-50%)}.joy-btn.left:hover{transform:translateY(-50%) scale(1.05)}.joy-btn.left.active,.joy-btn.left:active{transform:translateY(-50%) scale(.92)}
.joy-btn.right{right:-2px;top:50%;transform:translateY(-50%)}.joy-btn.right:hover{transform:translateY(-50%) scale(1.05)}.joy-btn.right.active,.joy-btn.right:active{transform:translateY(-50%) scale(.92)}
.joy-btn.home{top:50%;left:50%;transform:translate(-50%,-50%);width:24px;height:24px;font-size:8px;border-radius:4px}.joy-btn.home:hover{transform:translate(-50%,-50%) scale(1.05)}.joy-btn.home.active,.joy-btn.home:active{transform:translate(-50%,-50%) scale(.92)}
.joy-speed{display:flex;align-items:center;gap:6px;justify-content:center;margin-top:8px}
.joy-speed label{font-size:10px;color:var(--text-3)}
.joy-speed input{width:70px}
.zf-btns{display:flex;gap:4px}
.zf-btns button{flex:1}

/* Image controls */
.img-controls{display:grid;grid-template-columns:1fr 1fr;gap:8px 12px;padding:12px 16px;border-top:1px solid var(--border-0)}
.ic-group{display:flex;flex-direction:column;gap:4px}
.ic-head{display:flex;justify-content:space-between;align-items:center}
.ic-label{font-size:11px;font-weight:600;color:var(--text-2)}
.ic-val{font-family:var(--mono);font-size:11px;color:var(--text-1)}
.ic-group select{font-family:var(--font);font-size:12px;padding:5px 8px;background:var(--bg-0);border:1px solid var(--border-0);border-radius:var(--r-xs);color:var(--text-1);outline:none;-webkit-appearance:none;cursor:pointer}
.ic-group select:focus{border-color:var(--accent)}
.ic-section{grid-column:1/-1;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-3);padding:6px 0 0;margin-top:4px;border-top:1px solid var(--border-0)}.ic-section:first-child{border-top:none;margin-top:0;padding-top:0}

/* IWB */
.iwb-panel{border-top:1px solid var(--border-0);padding:12px 16px;background:var(--bg-1)}
.iwb-result{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:8px}
.iwb-card{background:var(--bg-3);border-radius:var(--r-xs);padding:8px 10px;text-align:center}
.iwb-card .num{font-family:var(--mono);font-size:18px;font-weight:600;line-height:1}
.iwb-card .lbl{font-size:10px;color:var(--text-3);margin-top:3px;text-transform:uppercase;letter-spacing:.3px}
.iwb-card .num.cool{color:#88ccff}.iwb-card .num.warm{color:#ffcc66}.iwb-card .num.ok{color:var(--green)}
.iwb-suggestion{margin-top:10px;padding:8px 12px;border-radius:var(--r-xs);font-size:12px;line-height:1.5;display:flex;align-items:center;gap:8px}
.iwb-suggestion.adjust{background:var(--amber-soft);color:var(--amber);border:1px solid var(--amber-dim)}
.iwb-suggestion.good{background:var(--green-soft);color:var(--green);border:1px solid var(--green-dim)}

/* Tracking */
.track-panel{border-top:1px solid var(--border-0);padding:12px 16px;background:var(--bg-2)}
.track-status{display:flex;align-items:center;gap:8px;margin-top:8px;font-size:12px}
.track-dot{width:8px;height:8px;border-radius:50%;background:var(--text-3)}
.track-dot.active{background:var(--green);box-shadow:0 0 6px var(--green-dim)}
.track-dot.lost{background:var(--red)}

/* ── Buttons ──────────────────────────────────────────────────────────────── */
.btn{font-family:var(--font);font-size:12px;font-weight:500;padding:5px 10px;border-radius:var(--r-xs);border:1px solid var(--border-1);background:var(--bg-4);color:var(--text-1);cursor:pointer;transition:all .12s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap;-webkit-app-region:no-drag}
.btn:hover{background:var(--bg-hover);border-color:var(--border-2)}
.btn:active,.btn.active{transform:scale(.97);background:var(--bg-hover);border-color:var(--border-2)}
.btn-xs{font-size:11px;padding:3px 7px}
.btn-accent{background:var(--accent);border-color:var(--accent);color:#fff}
.btn-accent:hover{background:#4a78ee;border-color:#4a78ee}
.btn-green{background:var(--green-soft);border-color:var(--green-dim);color:var(--green)}
.btn-green:hover{background:var(--green);color:#fff}
.btn-red{background:var(--red-soft);border-color:var(--red-dim);color:var(--red)}
.btn-red:hover{background:var(--red);color:#fff}

/* ── Add Camera Card ──────────────────────────────────────────────────────── */
.add-cam{background:var(--bg-2);border:2px dashed var(--border-1);border-radius:var(--r);padding:14px 16px;display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;transition:all .15s;color:var(--text-3);font-size:13px;font-weight:500;margin-bottom:10px}
.add-cam:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-soft)}
.add-cam:active{transform:scale(.99)}
.add-cam svg{flex-shrink:0}

/* ── Sidebar ──────────────────────────────────────────────────────────────── */
.sidebar-wrap{display:flex;position:relative}
.sidebar-toggle{width:28px;background:var(--bg-2);border:none;border-left:1px solid var(--border-0);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--text-3);transition:background .15s,color .15s;writing-mode:vertical-rl;padding:0}
.sidebar-toggle:hover{background:var(--bg-3);color:var(--text-1)}
.sidebar-toggle svg{transition:transform .25s}
.sidebar-wrap.collapsed .sidebar-toggle svg{transform:rotate(180deg)}
.sidebar-toggle-label{font-size:10px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;margin-top:10px;pointer-events:none}
.sidebar{width:var(--sidebar-w);border-left:1px solid var(--border-0);background:var(--bg-1);display:flex;flex-direction:column;overflow-y:auto;transition:width .25s ease,opacity .2s ease}
.sidebar-wrap.collapsed .sidebar{width:0;opacity:0;overflow:hidden;border-left:none;padding:0}
.sb-section{padding:16px;border-bottom:1px solid var(--border-0)}
.sb-section:last-child{border-bottom:none}
.sb-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-3);margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}

.cg{margin-bottom:12px}.cg:last-child{margin-bottom:0}
.cg-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.cg-label{font-size:12px;font-weight:500;color:var(--text-2)}
.cg-val{font-family:var(--mono);font-size:12px;color:var(--text-1)}
.cg select{font-family:var(--font);font-size:12px;width:100%;padding:6px 10px;background:var(--bg-0);border:1px solid var(--border-0);border-radius:var(--r-xs);color:var(--text-1);outline:none;-webkit-appearance:none;cursor:pointer}
.cg select:focus{border-color:var(--accent)}

input[type=range]{-webkit-appearance:none;width:100%;height:3px;background:var(--bg-0);border-radius:2px;outline:none;cursor:pointer}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);border:2px solid var(--bg-1);box-shadow:0 1px 5px var(--accent-dim);cursor:pointer;transition:transform .1s}
input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.15)}

/* ── Sync Targets ─────────────────────────────────────────────────────────── */
.st-list{display:flex;flex-direction:column;gap:4px}
.st-item{display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:var(--r-xs);background:var(--bg-0);border:1px solid var(--border-0);font-size:12px;transition:all .12s}
.st-item.active{border-color:var(--c,var(--accent))40}
.st-item .st-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.st-item .st-name{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.st-item .st-role{font-size:9px;text-transform:uppercase;letter-spacing:.4px;font-weight:700;padding:1px 5px;border-radius:3px;flex-shrink:0}
.st-item .st-role.src{background:var(--accent-soft);color:var(--accent)}
.st-item .st-role.tgt{background:var(--green-soft);color:var(--green)}
.st-item .st-role.off{background:var(--bg-3);color:var(--text-3)}
.st-item .st-check{width:16px;height:16px;border-radius:3px;border:2px solid var(--border-2);background:var(--bg-0);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s;flex-shrink:0;position:relative}
.st-item .st-check input{position:absolute;opacity:0;width:100%;height:100%;cursor:pointer;margin:0}
.st-item .st-check.checked{background:var(--green);border-color:var(--green)}
.st-item .st-check.checked::after{content:'';width:4px;height:7px;border:solid white;border-width:0 1.5px 1.5px 0;transform:rotate(45deg) translate(-1px,-1px)}

/* Sync area */
.sync-area{margin-top:auto;padding:16px;border-top:1px solid var(--border-0)}
.sync-btn{width:100%;padding:11px;font-size:13px;font-weight:700;border-radius:var(--r-sm);border:none;background:linear-gradient(135deg,var(--accent),#b07cff);color:#fff;cursor:pointer;transition:all .2s;font-family:var(--font);letter-spacing:.2px;display:flex;align-items:center;justify-content:center;gap:6px}
.sync-btn:hover{box-shadow:0 4px 18px var(--accent-dim);transform:translateY(-1px)}
.sync-btn:active{transform:translateY(0)}
.sync-btn:disabled{opacity:.35;cursor:not-allowed;transform:none;box-shadow:none}
.sync-btn .sp{display:none;width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
.sync-btn.syncing .sp{display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}

.status-line{font-size:11px;color:var(--text-3);display:flex;align-items:center;gap:5px;margin-top:8px}
.status-dot{width:5px;height:5px;border-radius:50%;background:var(--text-3)}
.status-dot.ok{background:var(--green)}.status-dot.warn{background:var(--amber)}

/* Mismatch */
.mm-bar{margin:0 0 10px;padding:8px 12px;background:var(--amber-soft);border:1px solid var(--amber-dim);border-radius:var(--r-xs);font-size:11px;color:var(--amber);display:none;align-items:center;gap:6px}
.mm-bar.vis{display:flex}

/* Collapsible sidebar sections */
.sb-collapse-toggle{display:flex;align-items:center;gap:6px;padding:12px 16px;cursor:pointer;font-size:11px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.6px;border-bottom:1px solid var(--border-0);transition:color .15s;user-select:none;background:var(--bg-2)}
.sb-collapse-toggle:hover{color:var(--text-1);background:var(--bg-3)}
.sb-collapse-toggle svg{transition:transform .2s}
.sb-collapse-toggle.open svg{transform:rotate(90deg)}
.sb-collapse-body{display:none;overflow:hidden}
.sb-collapse-body.open{display:block}

/* Toast */
.toasts{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);z-index:200;display:flex;flex-direction:column;align-items:center;gap:6px;pointer-events:none}
.toast{padding:8px 16px;background:var(--bg-4);border:1px solid var(--border-2);border-radius:var(--r-sm);font-size:12px;box-shadow:0 4px 20px rgba(0,0,0,.4);animation:tIn .25s ease,tOut .25s ease 2.7s forwards;pointer-events:auto}
.toast.ok{border-color:var(--green-dim);color:var(--green)}.toast.err{border-color:var(--red-dim);color:var(--red)}.toast.warn{border-color:var(--amber-dim);color:var(--amber)}
@keyframes tIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes tOut{to{opacity:0;transform:translateY(-4px)}}

::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border-1);border-radius:3px}
</style>
<!-- TensorFlow.js & Coco-SSD -->
<script src="../vendor/tf.js"></script>
<script src="../vendor/tensorflow-models/coco-ssd.js"></script>
<script src="../vendor/tensorflow-models/pose-detection.js"></script>
</head>
<body>
<div class="titlebar"><span>PiTiZed</span></div>
<div class="app">
  <div class="header">
    <div class="header-l">
      <div class="logo"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg></div>
      <h1>PiTiZed<span>Camera Controller</span></h1>
    </div>
    <div class="header-r">
      <button class="btn btn-xs" onclick="discover()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> Discover</button>
      <button class="btn btn-xs" onclick="refreshAll()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2v6h-6M3 22v-6h6"/><path d="M3 11.5a9 9 0 0 1 16.5-4M21 12.5a9 9 0 0 1-16.5 4"/></svg> Refresh</button>
      <button class="btn btn-xs" id="theme-btn" onclick="toggleTheme()" title="Toggle Theme" style="padding:3px 6px"></button>
    </div>
  </div>
  <div class="main">
    <div class="cam-panel">
      <div class="cam-panel-head">
        <div class="cam-panel-title">Cameras <span class="badge" id="cnt">0</span></div>
        <div style="display:flex;gap:6px;align-items:center">
          <span style="font-size:10px;color:var(--text-3)">Source:</span>
          <span id="src-lbl" style="font-size:11px;color:var(--accent);font-weight:600">None</span>
        </div>
      </div>
      <div class="mm-bar" id="mm-bar"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><span id="mm-txt"></span></div>
      <div id="cam-list"></div>
      <div style="display:flex;gap:10px">
        <div class="add-cam" onclick="addCamera()" style="flex:1">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Camera
        </div>
        <div class="add-cam" onclick="addCamera('mock')" style="width:auto;padding:0 16px" title="Add Simulated Camera">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar-wrap collapsed" id="sidebar-wrap">
      <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sync panel">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
        <span class="sidebar-toggle-label">Sync</span>
      </button>
    <div class="sidebar">
      <!-- Sync Targets -->
      <div class="sb-section">
        <div class="sb-title">
          <span>Sync Targets</span>
          <span style="display:flex;gap:4px">
            <button class="btn btn-xs" onclick="selectAllTargets(true)" style="padding:2px 6px;font-size:10px">All</button>
            <button class="btn btn-xs" onclick="selectAllTargets(false)" style="padding:2px 6px;font-size:10px">None</button>
          </span>
        </div>
        <div class="st-list" id="st-list"></div>
      </div>
      <!-- Colour Sync Settings (collapsible) -->
      <div class="sb-collapse-toggle" id="colour-sync-toggle" onclick="toggleColourSync()">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
        Colour Sync Settings
      </div>
      <div class="sb-collapse-body" id="colour-sync-body">
      <div class="sb-section">
        <div class="sb-title"><span>White Balance</span></div>
        <div class="cg"><div class="cg-head"><span class="cg-label">WB Mode</span></div>
          <select id="s-wb"><option value="0">Auto</option><option value="1">Indoor 3200K</option><option value="2">Outdoor 5600K</option><option value="3">One Push</option><option value="5">Manual</option><option value="32">VAR</option></select></div>
        <div class="cg" id="s-rg-wrap" style="display:none"><div class="cg-head"><span class="cg-label">Red Gain Tuning</span><span class="cg-val" id="s-rg-v">10</span></div><input type="range" id="s-rg" min="0" max="20" value="10" oninput="$('s-rg-v').textContent=this.value"></div>
        <div class="cg" id="s-bg-wrap" style="display:none"><div class="cg-head"><span class="cg-label">Blue Gain Tuning</span><span class="cg-val" id="s-bg-v">10</span></div><input type="range" id="s-bg" min="0" max="20" value="10" oninput="$('s-bg-v').textContent=this.value"></div>
      </div>
      <div class="sb-section">
        <div class="sb-title"><span>Image</span></div>
        <div class="cg"><div class="cg-head"><span class="cg-label">Saturation</span><span class="cg-val" id="s-sat-v">4</span></div><input type="range" id="s-sat" min="0" max="14" value="4" oninput="$('s-sat-v').textContent=this.value"></div>
        <div class="cg"><div class="cg-head"><span class="cg-label">Luminance</span><span class="cg-val" id="s-brt-v">7</span></div><input type="range" id="s-brt" min="0" max="14" value="7" oninput="$('s-brt-v').textContent=this.value"></div>
        <div class="cg"><div class="cg-head"><span class="cg-label">Contrast</span><span class="cg-val" id="s-con-v">7</span></div><input type="range" id="s-con" min="0" max="14" value="7" oninput="$('s-con-v').textContent=this.value"></div>
        <div class="cg"><div class="cg-head"><span class="cg-label">Hue</span><span class="cg-val" id="s-hue-v">7</span></div><input type="range" id="s-hue" min="0" max="14" value="7" oninput="$('s-hue-v').textContent=this.value"></div>
        <div class="cg"><div class="cg-head"><span class="cg-label">Sharpness</span><span class="cg-val" id="s-shp-v">6</span></div><input type="range" id="s-shp" min="0" max="16" value="6" oninput="$('s-shp-v').textContent=this.value"></div>
      </div>
      <div class="sb-section">
        <div class="sb-title"><span>Exposure</span></div>
        <div class="cg"><div class="cg-head"><span class="cg-label">Mode</span></div>
          <select id="s-exp"><option value="0">Auto</option><option value="3">Manual</option><option value="10">Shutter Priority</option><option value="11">Iris Priority</option></select></div>
        <div class="cg"><div class="cg-head"><span class="cg-label">Gain</span><span class="cg-val" id="s-gain-v">0</span></div><input type="range" id="s-gain" min="0" max="7" value="0" oninput="$('s-gain-v').textContent=this.value"></div>
        <div class="cg"><div class="cg-head"><span class="cg-label">Gain Limit</span><span class="cg-val" id="s-gainlimit-v">15</span></div><input type="range" id="s-gainlimit" min="0" max="15" value="15" oninput="$('s-gainlimit-v').textContent=this.value"></div>
        <div class="cg"><div class="cg-head"><span class="cg-label">Iris</span><span class="cg-val" id="s-iris-v">0</span></div><input type="range" id="s-iris" min="0" max="17" value="0" oninput="$('s-iris-v').textContent=this.value"></div>
        <div class="cg"><div class="cg-head"><span class="cg-label">Shutter</span><span class="cg-val" id="s-shutter-v">1</span></div><input type="range" id="s-shutter" min="1" max="17" value="1" oninput="$('s-shutter-v').textContent=this.value"></div>
        <div class="cg"><div class="cg-head"><span class="cg-label">Backlight</span></div>
          <select id="s-bl"><option value="3">Off</option><option value="2">On</option></select></div>
        <div class="cg"><div class="cg-head"><span class="cg-label">DRC</span><span class="cg-val" id="s-drc-v">0</span></div><input type="range" id="s-drc" min="0" max="8" value="0" oninput="$('s-drc-v').textContent=this.value"></div>
      </div>
      <div class="sb-section" style="border-bottom:none">
        <div class="sb-title"><span>Noise Reduction</span></div>
        <div class="cg"><div class="cg-head"><span class="cg-label">NR 2D</span><span class="cg-val" id="s-nr2d-v">0</span></div><input type="range" id="s-nr2d" min="0" max="6" value="0" oninput="$('s-nr2d-v').textContent=this.value"></div>
      </div>
      </div>
      <div class="sync-area">
        <button class="sync-btn" id="sync-btn" onclick="syncSelected()" disabled>
          <span class="sp"></span>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 2v6h-6M3 22v-6h6"/><path d="M3 11.5a9 9 0 0 1 16.5-4M21 12.5a9 9 0 0 1-16.5 4"/></svg>
          <span id="sync-btn-label">Sync to Selected</span>
        </button>
        <div class="status-line"><span class="status-dot" id="s-dot"></span><span id="s-status">No cameras connected</span></div>
      </div>
    </div>
    </div>
  </div>
</div>
<div class="toasts" id="toasts"></div>

<script>
const $ = id => document.getElementById(id);

// ── Color Palette (cycles for any number of cameras) ─────────────────────────
const COLORS = ['#5b8aff','#b07cff','#3dd68c','#f0b429','#f06060','#00bcd4','#ff7eb3','#8bc34a','#ff9800','#9c27b0','#00e5ff','#ff6e40'];
function camColor(i) { return COLORS[i % COLORS.length]; }

// ── State ────────────────────────────────────────────────────────────────────
let cams = [];       // { id, ip, on, info, cfg, name, syncTarget, username, password }
let srcIdx = -1;     // source camera index (in cams array)
let expandedIdx = -1;
let snapshotTimers = {};
let trackTimers = {};
let nextId = 0;
let removeConfirm = {}; // track double-click-to-remove per id

function makeCam(ip = '', name = null, username = 'admin', password = 'admin') {
  const id = nextId++;
  const n = name || `Camera ${cams.length + 1}`;
  return { id, ip, on: false, info: null, cfg: {}, name: n, syncTarget: true, username, password, trackModel: 'coco', shotProfile: 'tight', nativeTracking: false };
}

// Start with 3 cameras
for (let i = 0; i < 3; i++) cams.push(makeCam());

// ── Sidebar Toggle ───────────────────────────────────────────────────────────
function toggleSidebar() {
  $('sidebar-wrap').classList.toggle('collapsed');
}

// ── Colour Sync Panel Toggle ─────────────────────────────────────────────────
function toggleColourSync() {
  const toggle = $('colour-sync-toggle');
  const body = $('colour-sync-body');
  toggle.classList.toggle('open');
  body.classList.toggle('open');
}

// ── WB Mode toggle (gain tuning visible for Auto=0, OnePush=3, VAR=32) ──────
$('s-wb').addEventListener('change', () => {
  const v = $('s-wb').value;
  const showTuning = ['0','3','32'].includes(v);
  $('s-rg-wrap').style.display = showTuning ? 'block' : 'none';
  $('s-bg-wrap').style.display = showTuning ? 'block' : 'none';
});

// ── Theme ────────────────────────────────────────────────────────────────────
function toggleTheme() {
  const isLight = document.documentElement.getAttribute('data-theme') === 'light';
  const next = isLight ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('ptz_theme', next);
  updateThemeIcon(next);
}

function updateThemeIcon(theme) {
  const btn = $('theme-btn');
  if (!btn) return;
  btn.innerHTML = theme === 'light' ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>';
}

// ── Add / Remove cameras ────────────────────────────────────────────────────
function addCamera(ip = '') {
  cams.push(makeCam(ip));
  render();
  toast(`Camera ${cams.length} added`);
  persistLayout();
}

function removeCamera(i) {
  const c = cams[i];
  const key = c.id;

  // Require double click to confirm
  if (!removeConfirm[key]) {
    removeConfirm[key] = true;
    render(); // shows red confirm state
    setTimeout(() => { delete removeConfirm[key]; render(); }, 2000);
    return;
  }

  delete removeConfirm[key];
  stopSnapshot(c.id);
  stopTracking(c.id);

  // Adjust indices
  if (expandedIdx === i) expandedIdx = -1;
  else if (expandedIdx > i) expandedIdx--;

  if (srcIdx === i) {
    srcIdx = -1;
    // Find next connected camera as source
    const nextSrc = cams.findIndex((cam, idx) => idx !== i && cam.on);
    if (nextSrc >= 0) srcIdx = nextSrc > i ? nextSrc - 1 : nextSrc;
  } else if (srcIdx > i) srcIdx--;

  cams.splice(i, 1);
  toast(`${c.name} removed`);
  render();
  persistLayout();
}

// ── Sync target toggles ────────────────────────────────────────────────────
function toggleSyncTarget(i) {
  cams[i].syncTarget = !cams[i].syncTarget;
  render();
}

function selectAllTargets(val) {
  cams.forEach(c => { if (c.on) c.syncTarget = val; });
  render();
}

// ── Render ───────────────────────────────────────────────────────────────────
function render() {
  const list = $('cam-list');
  list.innerHTML = cams.map((c, i) => {
    const on = c.on, exp = i === expandedIdx && on, src = i === srcIdx;
    const color = camColor(i);
    const isConfirm = removeConfirm[c.id];
    return `<div class="cam ${on?'on':''} ${src?'source':''} ${exp?'expanded':''} ${on && c.syncTarget?'sync-target':''}" style="--c:${color}" data-i="${i}">
      <div class="cam-top" onclick="toggleExpand(${i})">
        <div class="cam-left">
          <div class="cam-dot"></div>
          <div class="cam-name-wrap">
            <div class="cam-name" id="cname-${i}" ondblclick="event.stopPropagation();startRename(${i})">${c.name}</div>
            <div class="cam-sub">${on?(c.info?.model||'Camera'):'Not connected'}</div>
          </div>
        </div>
        <div class="cam-right" onclick="event.stopPropagation()">
          ${on && src ? '<span class="src-tag">Source</span>' : ''}
          ${on && !src ? `<button class="btn btn-xs" onclick="setSource(${i})">Set Source</button>` : ''}
          <input class="cam-ip" placeholder="192.168.1.${100+i}" value="${c.ip}" id="ip-${i}" ${on?'disabled':''} onkeydown="if(event.key==='Enter')connect(${i})" style="width:120px">
          ${!on ? `<input class="cam-ip" placeholder="Username" value="${c.username||'admin'}" id="user-${i}" style="width:90px" onkeydown="if(event.key==='Enter')connect(${i})">` : ''}
          ${!on ? `<input class="cam-ip" type="password" placeholder="Password" value="${c.password||'admin'}" id="pass-${i}" style="width:90px" onkeydown="if(event.key==='Enter')connect(${i})">` : ''}
          <button class="btn btn-xs" onclick="${on?`disconnect(${i})`:`connect(${i})`}">${on?'Disconnect':'Connect'}</button>
          ${on?`<svg class="expand-arrow" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" onclick="event.stopPropagation();toggleExpand(${i})" style="cursor:pointer"><polyline points="6 9 12 15 18 9"/></svg>`:''}
          <button class="cam-remove ${isConfirm?'confirm':''}" onclick="event.stopPropagation();removeCamera(${i})" title="${isConfirm?'Click again to confirm':'Remove camera'}">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      </div>
      ${on && !exp ? renderPreview(c, i) : ''}
      ${on ? `<div class="cam-body">${renderExpanded(c, i)}</div>` : ''}
    </div>`;
  }).join('');
  renderSyncTargets();
  updateGlobals();
}

function renderPreview(c, i) {
  const wbMap = {0:'Auto',1:'Indoor',2:'Outdoor',3:'OnePush',5:'Manual',32:'VAR'};
  const items = [
    ['WB', wbMap[c.cfg.wb_mode] ?? '—'],['RGT', c.cfg.rgaintuning ?? '—'],['BGT', c.cfg.bgaintuning ?? '—'],
    ['Sat', c.cfg.saturation ?? '—'],['Brt', c.cfg.bright ?? '—'],['Con', c.cfg.contrast ?? '—'],
    ['Hue', c.cfg.hue ?? '—'],['Shp', c.cfg.sharpness ?? '—']
  ];
  return `<div class="cam-preview">${items.map(([l,v]) =>
    `<div class="pv-item"><span class="pv-label">${l}</span><span class="pv-val ${hasMM(l)?'mm':''}">${v}</span></div>`
  ).join('')}</div>`;
}

function hasMM(label) {
  const keyMap = {WB:'wb_mode',RGT:'rgaintuning',BGT:'bgaintuning',Sat:'saturation',Brt:'bright',Con:'contrast',Hue:'hue',Shp:'sharpness'};
  const k = keyMap[label]; if (!k) return false;
  const vals = cams.filter(c=>c.on).map(c=>c.cfg[k]);
  return vals.length > 1 && !vals.every(v=>v===vals[0]);
}

function renderExpanded(c, i) {
  const cfg = c.cfg;
  // G3 API WB modes: 0=Auto, 1=Indoor, 2=Outdoor, 3=OnePush, 5=Manual, 32=VAR
  const wbModes = [{v:0,n:'Auto'},{v:1,n:'Indoor'},{v:2,n:'Outdoor'},{v:3,n:'One Push'},{v:5,n:'Manual'},{v:32,n:'VAR'}];
  // G3 API Exposure modes: 0=Auto, 3=Manual, 10=SAE (Shutter Pri.), 11=AAE (Iris Pri.)
  const expModes = [{v:0,n:'Auto'},{v:3,n:'Manual'},{v:10,n:'Shutter Pri.'},{v:11,n:'Iris Pri.'}];
  return `
  <div class="cam-body-inner">
    <div style="display:flex;flex-direction:column">
      <div class="viewfinder" id="vf-${i}">
        <img id="vf-img-${i}" style="display:none">
        <div class="vf-placeholder" id="vf-ph-${i}">Loading feed…</div>
        <div class="vf-overlay">
          <span class="vf-badge" id="vf-fps-${i}">—</span>
          <div class="vf-actions">
            <span class="vf-wb-badge" id="vf-wb-${i}"></span>
            <button class="vf-action-btn ${c.nativeTracking?'active':''}" id="vf-nat-${i}" onclick="toggleNativeTracking(${i})" title="Camera native auto-tracking">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12h5M17 12h5M12 2v5M12 17v5"/><circle cx="12" cy="12" r="3"/></svg>
              ${c.nativeTracking?'AT On':'AT Off'}
            </button>
            <button class="vf-action-btn" onclick="takeSnapshot(${i})" title="Save snapshot">
              <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="12" cy="12" r="3"/></svg>
              Snap
            </button>
          </div>
        </div>
      </div>
      <div class="ptz-controls">
        <div class="ctrl-section">
          <div class="ctrl-title"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 9l7-7 7 7M5 15l7 7 7-7"/></svg> Pan / Tilt</div>
          <div class="joystick">
            <div class="joy-btn up" onmousedown="ptzCmd(${i},'up')" onmouseup="ptzCmd(${i},'ptzstop')" onmouseleave="ptzCmd(${i},'ptzstop')">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
            </div>
            <div class="joy-btn down" onmousedown="ptzCmd(${i},'down')" onmouseup="ptzCmd(${i},'ptzstop')" onmouseleave="ptzCmd(${i},'ptzstop')">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
            </div>
            <div class="joy-btn left" onmousedown="ptzCmd(${i},'left')" onmouseup="ptzCmd(${i},'ptzstop')" onmouseleave="ptzCmd(${i},'ptzstop')">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            </div>
            <div class="joy-btn right" onmousedown="ptzCmd(${i},'right')" onmouseup="ptzCmd(${i},'ptzstop')" onmouseleave="ptzCmd(${i},'ptzstop')">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
            </div>
            <div class="joy-btn home" onmousedown="ptzCmd(${i},'home')">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            </div>
          </div>
          <div class="joy-speed"><label>Speed</label><input type="range" min="1" max="20" value="8" id="ptz-spd-${i}"></div>
        </div>
        <div class="ctrl-section">
          <div class="ctrl-title"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg> Zoom</div>
          <div class="zf-btns">
            <button class="btn btn-xs btn-zoom-out" onmousedown="zoomCmd(${i},'zoomout')" onmouseup="zoomCmd(${i},'zoomstop')" onmouseleave="zoomCmd(${i},'zoomstop')">− Wide</button>
            <button class="btn btn-xs btn-zoom-in" onmousedown="zoomCmd(${i},'zoomin')" onmouseup="zoomCmd(${i},'zoomstop')" onmouseleave="zoomCmd(${i},'zoomstop')">+ Tele</button>
          </div>
        </div>
        <div class="ctrl-section" style="border-bottom:none">
          <div class="ctrl-title"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg> Focus</div>
          <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px">
            <select class="btn btn-xs" style="border:1px solid var(--border-1);padding:3px 7px" onchange="setFocusMode(${i},this.value)">
              <option value="2" ${cfg.focus_mode==2?'selected':''}>Auto</option>
              <option value="3" ${cfg.focus_mode==3?'selected':''}>Manual</option>
            </select>
          </div>
          <div class="zf-btns">
            <button class="btn btn-xs btn-focus-in" onmousedown="focusCmd(${i},'focusin')" onmouseup="focusCmd(${i},'focusstop')" onmouseleave="focusCmd(${i},'focusstop')">Near</button>
            <button class="btn btn-xs btn-focus-out" onmousedown="focusCmd(${i},'focusout')" onmouseup="focusCmd(${i},'focusstop')" onmouseleave="focusCmd(${i},'focusstop')">Far</button>
          </div>
        </div>
      </div>
    </div>
    <div>
      <div class="track-panel">
        <div class="ctrl-title" style="margin-bottom:0">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12h5M17 12h5M12 2v5M12 17v5"/><circle cx="12" cy="12" r="3"/></svg>
          AI Tracking
          <select class="btn btn-xs" style="padding:2px 5px;border:1px solid var(--border-1)" onchange="setTrackModel(${i},this.value)" ${c.tracking?'disabled':''}>
            <option value="coco" ${(c.trackModel||'coco')==='coco'?'selected':''}>COCO-SSD</option>
            <option value="movenet" ${c.trackModel==='movenet'?'selected':''}>MoveNet</option>
          </select>
          <select class="btn btn-xs" style="padding:2px 5px;border:1px solid var(--border-1)" onchange="setShotProfile(${i},this.value)">
            ${Object.entries(SHOT_PROFILES).map(([k,v]) => `<option value="${k}" ${(c.shotProfile||'tight')===k?'selected':''}>${v.label}</option>`).join('')}
          </select>
          <button class="btn btn-xs ${c.tracking?'btn-red':''}" onclick="toggleTracking(${i})">${c.tracking?'Stop':'Start'}</button>
        </div>
        <div class="track-status">
          <div class="track-dot ${c.tracking?'active':''}" id="trk-dot-${i}"></div>
          <span id="trk-stat-${i}">${c.tracking ? 'Searching for subject…' : 'Ready to track'}</span>
        </div>
      </div>
      <div class="iwb-panel">
        <div class="ctrl-title" style="margin-bottom:0">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v1m0 16v1m-8-9H3m18 0h-1"/><circle cx="12" cy="12" r="4"/></svg>
          Intelligent White Balance
          <button class="btn btn-xs btn-green" onclick="analyzeWB(${i})">Analyze Feed</button>
        </div>
        <div id="iwb-${i}">
          <div class="iwb-result">
            <div class="iwb-card temp"><div class="num" id="iwb-temp-${i}">—</div><div class="lbl">Est. Kelvin</div></div>
            <div class="iwb-card"><div class="num" id="iwb-rshift-${i}">—</div><div class="lbl">Red Shift</div></div>
            <div class="iwb-card"><div class="num" id="iwb-bshift-${i}">—</div><div class="lbl">Blue Shift</div></div>
          </div>
          <div id="iwb-sug-${i}"></div>
        </div>
      </div>
      <div class="img-controls">
        <div class="ic-section">White Balance</div>
        <div class="ic-group"><div class="ic-head"><span class="ic-label">WB Mode</span></div>
          <select onchange="setCamImg(${i},'wb_mode',this.value)">${wbModes.map(m=>`<option value="${m.v}" ${cfg.wb_mode==m.v?'selected':''}>${m.n}</option>`).join('')}</select></div>
        <div style="display:flex;flex-direction:column;gap:6px">
          ${mkSlider(i,'Red Gain Tuning','rgaintuning',0,20,cfg.rgaintuning??10,'img')}
          ${mkSlider(i,'Blue Gain Tuning','bgaintuning',0,20,cfg.bgaintuning??10,'img')}
        </div>
        <div class="ic-section">Image</div>
        <div style="display:flex;flex-direction:column;gap:6px">
          ${mkSlider(i,'Saturation','saturation',0,14,cfg.saturation??4,'img')}
          ${mkSlider(i,'Brightness','bright',0,14,cfg.bright??7,'img')}
        </div>
        ${mkSlider(i,'Contrast','contrast',0,14,cfg.contrast??7,'img')}
        ${mkSlider(i,'Hue','hue',0,14,cfg.hue??7,'img')}
        ${mkSlider(i,'Sharpness','sharpness',0,16,cfg.sharpness??6,'img')}
        <div class="ic-section">Exposure</div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <div class="ic-group"><div class="ic-head"><span class="ic-label">Mode</span></div>
            <select onchange="setCamExp(${i},'exposure_mode',this.value)">${expModes.map(m=>`<option value="${m.v}" ${cfg.exposure_mode==m.v?'selected':''}>${m.n}</option>`).join('')}</select></div>
          <div class="ic-group"><div class="ic-head"><span class="ic-label">Backlight</span></div>
            <select onchange="setCamExp(${i},'backlight',this.value)"><option value="3" ${cfg.backlight!=2?'selected':''}>Off</option><option value="2" ${cfg.backlight==2?'selected':''}>On</option></select></div>
          <div class="ic-group"><div class="ic-head"><span class="ic-label">Anti-Flicker</span></div>
            <select onchange="setCamExp(${i},'anti_flicker',this.value)"><option value="0" ${cfg.anti_flicker==0?'selected':''}>Off</option><option value="1" ${cfg.anti_flicker==1?'selected':''}>50Hz</option><option value="2" ${cfg.anti_flicker==2?'selected':''}>60Hz</option></select></div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px">
          ${mkSlider(i,'Gain','gain',0,7,cfg.gain??0,'exp')}
          ${mkSlider(i,'Gain Limit','gainLimit',0,15,cfg.gainLimit??15,'exp')}
          ${mkSlider(i,'Iris','iris',0,17,cfg.iris??0,'exp')}
          ${mkSlider(i,'Shutter','shutter',1,17,cfg.shutter??1,'exp')}
          ${mkSlider(i,'DRC','drc',0,8,cfg.drc??0,'exp')}
        </div>
        <div class="ic-section">Noise Reduction</div>
        <div style="display:flex;flex-direction:column;gap:6px">
          ${mkSlider(i,'NR 2D','nr2d',0,6,cfg.nr2d??0,'img')}
        </div>
      </div>
      <div class="feed-panel">
        <div class="ctrl-title" style="margin-bottom:0">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
          Feed & Resolution
          <button class="btn btn-xs" onclick="loadVideoConfig(${i})">Refresh</button>
        </div>
        <div id="feed-cfg-${i}" class="feed-grid" style="margin-top:8px">
          <div class="feed-field">
            <label>Video Output (SE)</label>
            <select id="feed-vout-${i}" onchange="setVideoParam(${i},'video_ability',this.value)">
              <option value="all-30fps">All @ 30fps</option>
              <option value="USB_IP">USB + IP @ 60fps</option>
              <option value="USB_HDMI-SDI">USB + HDMI/SDI @ 60fps</option>
              <option value="HDMI-SDI_IP">HDMI/SDI + IP @ 60fps</option>
            </select>
          </div>
          <div class="feed-field">
            <label>Refresh Rate</label>
            <select id="feed-vinorm-${i}" onchange="setVideoParam(${i},'vinorm',this.value)">
              <option value="60">60Hz</option>
              <option value="50">50Hz</option>
              <option value="dial">Dial Priority</option>
            </select>
          </div>
          <div class="feed-field">
            <label>Stream 1 Resolution</label>
            <select id="feed-size1-${i}" onchange="setVideoParam(${i},'size_1',this.value)">
              <option value="PIC_HD1080">1920x1080</option>
              <option value="PIC_HD720">1280x720</option>
              <option value="PIC_960_540">960x540</option>
              <option value="PIC_HD576">1024x576</option>
              <option value="PIC_D1">720x480</option>
              <option value="PIC_VGA">640x480</option>
              <option value="PIC_640_360">640x360</option>
            </select>
          </div>
          <div class="feed-field">
            <label>Stream 1 Codec</label>
            <select id="feed-proto1-${i}" onchange="setVideoParam(${i},'protocol_1',this.value)">
              <option value="H264">H.264</option>
              <option value="H265">H.265</option>
            </select>
          </div>
          <div class="feed-field">
            <label>Stream 1 FPS</label>
            <input type="number" id="feed-fps1-${i}" min="1" max="60" value="30" onchange="setVideoParam(${i},'fps_1',this.value)">
          </div>
          <div class="feed-field">
            <label>Stream 1 Bitrate (kbps)</label>
            <input type="number" id="feed-bps1-${i}" min="32" max="102400" value="8192" onchange="setVideoParam(${i},'bps_1',this.value)">
          </div>
          <div class="feed-field">
            <label>Bitrate Control</label>
            <select id="feed-rc1-${i}" onchange="setVideoParam(${i},'rcmode_1',this.value)">
              <option value="VBR">VBR</option>
              <option value="CBR">CBR</option>
            </select>
          </div>
          <div class="feed-field">
            <label>Encode Profile</label>
            <select id="feed-profile-${i}" onchange="setVideoParam(${i},'profile',this.value)">
              <option value="mainprofile">Main</option>
              <option value="highprofile">High</option>
            </select>
          </div>
        </div>
      </div>
      <div class="adv-panel">
        <div class="adv-toggle" id="adv-tog-${i}" onclick="toggleAdvanced(${i})">
          <svg width="8" height="8" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
          Advanced Settings
        </div>
        <div class="adv-body" id="adv-body-${i}">
          <div class="adv-section">Stream 2</div>
          <div class="adv-row"><label>Resolution</label>
            <select onchange="setVideoParam(${i},'size_2',this.value)">
              <option value="PIC_HD720">1280x720</option>
              <option value="PIC_D1">720x480</option>
              <option value="PIC_720_408">720x408</option>
              <option value="PIC_VGA">640x480</option>
              <option value="PIC_640_360">640x360</option>
              <option value="PIC_QVGA">320x240</option>
            </select></div>
          <div class="adv-row"><label>Codec</label>
            <select onchange="setVideoParam(${i},'protocol_2',this.value)">
              <option value="H264">H.264</option><option value="H265">H.265</option><option value="MJPEG">MJPEG</option>
            </select></div>
          <div class="adv-row"><label>FPS</label><input type="number" min="1" max="60" value="30" onchange="setVideoParam(${i},'fps_2',this.value)"></div>
          <div class="adv-row"><label>Bitrate (kbps)</label><input type="number" min="32" max="20480" value="2048" onchange="setVideoParam(${i},'bps_2',this.value)"></div>
          <div class="adv-row"><label>I-Frame Interval</label><input type="number" min="1" max="1200" value="30" onchange="setVideoParam(${i},'gop_2',this.value)"></div>

          <div class="adv-section">NDI / Video Template</div>
          <div class="adv-row"><label>Video Template</label>
            <select onchange="setVideoParam(${i},'ndi_mode',this.value)">
              <option value="off">Off</option>
              <option value="high">High (1080p60)</option>
              <option value="medium">Medium (1080p30)</option>
              <option value="low">Low (720p30)</option>
            </select></div>
          <div class="adv-row"><label>I-Frame Interval (S1)</label><input type="number" min="1" max="1200" value="30" onchange="setVideoParam(${i},'gop_1',this.value)"></div>

          <div class="adv-section">Auto-Tracking (SE)</div>
          <div class="adv-row"><label>Tracking Start</label>
            <select onchange="setTrackPresetCmd(${i},this.value)">
              <option value="live">Current Position</option>
              <option value="home">Home Preset</option>
            </select></div>
          <div class="adv-row"><label>Tracking Overlay</label>
            <select onchange="setImageValueCmd(${i},'trackingoverlay',this.value)">
              <option value="0">Off</option><option value="1">On</option>
            </select></div>
          <div class="adv-row"><label>Display Info</label>
            <select onchange="setImageValueCmd(${i},'displayinfo',this.value)">
              <option value="3">Off</option><option value="2">On</option>
            </select></div>
          <div class="adv-row"><label>Motion Sync</label>
            <select onchange="setImageValueCmd(${i},'motionsync',this.value)">
              <option value="2">On</option><option value="3">Off</option>
            </select></div>
          <div class="adv-row"><label>Preset Tour</label>
            <select onchange="setImageValueCmd(${i},'presetinspection',this.value)">
              <option value="3">Off</option><option value="2">On</option>
            </select></div>
          <div class="adv-row"><label>Preset Freeze</label>
            <select onchange="setImageValueCmd(${i},'presetfreeze',this.value)">
              <option value="3">Off</option><option value="2">On</option>
            </select></div>

          <div class="adv-section">Image</div>
          <div class="adv-row"><label>Orientation</label>
            <select onchange="setImageValueCmd(${i},'imageOrientation',this.value)">
              <option value="0">Normal</option><option value="1">Flip</option><option value="2">Mirror</option><option value="3">Flip + Mirror</option>
            </select></div>
          <div class="adv-row"><label>2D NR (SE)</label>
            <select onchange="setImageValueCmd(${i},'noise2d',this.value)">
              <option value="0">Off</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">Auto</option>
            </select></div>

          <div class="adv-section">Audio</div>
          <div class="adv-row"><label>Audio Encoding</label>
            <select onchange="setAudioParamCmd(${i},'audio_switch',this.value)">
              <option value="0">Off</option><option value="1">On</option>
            </select></div>
          <div class="adv-row"><label>Sample Rate</label>
            <select onchange="setAudioParamCmd(${i},'samplerate',this.value)">
              <option value="32">32 kHz</option><option value="44.1">44.1 kHz</option><option value="48">48 kHz</option>
            </select></div>
          <div class="adv-row"><label>Audio Bitrate</label>
            <select onchange="setAudioParamCmd(${i},'streamrate',this.value)">
              <option value="96">96 kbps</option><option value="128">128 kbps</option>
            </select></div>
          <div class="adv-row"><label>Input Volume (0-30)</label><input type="number" min="0" max="30" value="15" onchange="setAudioParamCmd(${i},'volume_value',this.value)"></div>
          <div class="adv-row"><label>USB Audio</label>
            <select onchange="setAudioParamCmd(${i},'usbaudio_switch',this.value)">
              <option value="0">Off</option><option value="1">On</option>
            </select></div>
          <div class="adv-row"><label>Line Out</label>
            <select onchange="setAudioParamCmd(${i},'lineout_switch',this.value)">
              <option value="0">Off</option><option value="1">On (HDMI)</option><option value="2">Line Out</option>
            </select></div>

          <div class="adv-section">Streaming</div>
          <div class="adv-row"><label>RTSP Auth</label>
            <select onchange="setNetworkParamCmd(${i},'rtsp_auth_en',this.value)">
              <option value="0">Off</option><option value="1">On</option>
            </select></div>
          <div class="adv-row"><label>ONVIF</label>
            <select onchange="setNetworkParamCmd(${i},'onvif_en',this.value)">
              <option value="0">Off</option><option value="1">On</option>
            </select></div>
          <div class="adv-row"><label>SRT</label>
            <select onchange="setNetworkParamCmd(${i},'srt_en',this.value)">
              <option value="0">Off</option><option value="1">On</option>
            </select></div>

          <div class="adv-section">System</div>
          <div class="adv-row"><label>IR Channel</label>
            <select onchange="setIRChannel(${i},this.value)">
              <option value="1">CH 1</option><option value="2">CH 2</option><option value="3">CH 3</option><option value="4">CH 4</option>
            </select></div>
          <div class="adv-row"><label>Menu Reset</label><button class="btn btn-xs adv-btn" onclick="menuResetCmd(${i})">Reset</button></div>
          <div class="adv-row"><label>Reboot Camera</label><button class="btn btn-xs adv-btn" style="color:var(--red)" onclick="rebootCmd(${i})">Reboot</button></div>
        </div>
      </div>
    </div>
  </div>`;
}

function mkSlider(i, label, param, min, max, val, cat) {
  const uid = `c${i}-${param}`;
  const fn = cat === 'exp' ? 'setCamExp' : 'setCamImg';
  return `<div class="ic-group"><div class="ic-head"><span class="ic-label">${label}</span><span class="ic-val" id="${uid}-v">${val}</span></div>
    <input type="range" min="${min}" max="${max}" value="${val}" id="${uid}" oninput="$('${uid}-v').textContent=this.value" onchange="${fn}(${i},'${param}',this.value)"></div>`;
}

// ── Feed & Resolution / Advanced Settings ────────────────────────────────────
async function loadVideoConfig(i) {
  const c = cams[i];
  if (!c || !c.on) { toast('Camera not connected', 'warn'); return; }
  toast('Loading video config…');
  const r = await window.ptz.getVideoConfig(c.ip, getAuth(i));
  if (!r.success) { toast('Failed: ' + (r.error || 'unknown'), 'err'); return; }
  const v = r.config;
  // Populate feed panel fields with current values
  const setVal = (id, val) => { const el = $(id); if (el && val !== undefined) el.value = val; };
  setVal(`feed-vout-${i}`, v.video_ability);
  setVal(`feed-vinorm-${i}`, v.vinorm);
  setVal(`feed-size1-${i}`, v.size_1);
  setVal(`feed-proto1-${i}`, v.protocol_1);
  setVal(`feed-fps1-${i}`, v.fps_1);
  setVal(`feed-bps1-${i}`, v.bps_1);
  setVal(`feed-rc1-${i}`, v.rcmode_1);
  setVal(`feed-profile-${i}`, v.profile);
  toast('Video config loaded', 'ok');
}

async function setVideoParam(i, key, val) {
  const c = cams[i];
  if (!c || !c.on) return;
  const r = await window.ptz.setVideoParam(c.ip, { [key]: val }, getAuth(i));
  if (r.success) toast(`Set ${key}`, 'ok');
  else toast(`Failed: ${r.error}`, 'err');
}

async function setAudioParamCmd(i, key, val) {
  const c = cams[i];
  if (!c || !c.on) return;
  const r = await window.ptz.setAudioParam(c.ip, { [key]: val }, getAuth(i));
  if (r.success) toast(`Set ${key}`, 'ok');
  else toast(`Failed: ${r.error}`, 'err');
}

async function setImageValueCmd(i, param, val) {
  const c = cams[i];
  if (!c || !c.on) return;
  const r = await window.ptz.setImageValue(c.ip, param, val, getAuth(i));
  if (r.success) toast(`Set ${param}`, 'ok');
  else toast(`Failed: ${r.error}`, 'err');
}

async function setNetworkParamCmd(i, key, val) {
  const c = cams[i];
  if (!c || !c.on) return;
  const r = await window.ptz.setNetworkParam(c.ip, { [key]: val }, getAuth(i));
  if (r.success) toast(`Set ${key}`, 'ok');
  else toast(`Failed: ${r.error}`, 'err');
}

async function setOverlayCmd(i, param, val) {
  const c = cams[i];
  if (!c || !c.on) return;
  const r = await window.ptz.setOverlay(c.ip, param, val, getAuth(i));
  if (r.success) toast(`Set ${param}`, 'ok');
  else toast(`Failed: ${r.error}`, 'err');
}

async function setIRChannel(i, ch) {
  const c = cams[i];
  if (!c || !c.on) return;
  const r = await window.ptz.setIRChannel(c.ip, ch, getAuth(i));
  if (r.success) toast(`IR Channel ${ch}`, 'ok');
  else toast(`Failed: ${r.error}`, 'err');
}

async function setTrackPresetCmd(i, val) {
  const c = cams[i];
  if (!c || !c.on) return;
  const r = await window.ptz.setTrackPreset(c.ip, val, getAuth(i));
  if (r.success) toast(`Tracking start: ${val}`, 'ok');
  else toast(`Failed: ${r.error}`, 'err');
}

async function menuResetCmd(i) {
  const c = cams[i];
  if (!c || !c.on) return;
  if (!confirm('Reset non-network settings to factory defaults?')) return;
  const r = await window.ptz.setOverlay(c.ip, 'osdreset', 'trigger', getAuth(i));
  if (r.success) toast('Menu reset sent', 'ok');
  else toast(`Failed: ${r.error}`, 'err');
}

async function rebootCmd(i) {
  const c = cams[i];
  if (!c || !c.on) return;
  if (!confirm(`Reboot ${c.name}? Camera will be offline for ~30 seconds.`)) return;
  const r = await window.ptz.reboot(c.ip, getAuth(i));
  if (r.success) toast('Rebooting camera…', 'ok');
  else toast(`Failed: ${r.error}`, 'err');
}

function toggleAdvanced(i) {
  const tog = $(`adv-tog-${i}`);
  const body = $(`adv-body-${i}`);
  if (!tog || !body) return;
  const isOpen = body.classList.toggle('open');
  tog.classList.toggle('open', isOpen);
}

// ── Sidebar Sync Targets ─────────────────────────────────────────────────────
function renderSyncTargets() {
  const list = $('st-list');
  if (cams.length === 0) {
    list.innerHTML = '<div style="font-size:11px;color:var(--text-3);text-align:center;padding:8px">No cameras added</div>';
    return;
  }
  list.innerHTML = cams.map((c, i) => {
    const isSrc = i === srcIdx;
    const color = camColor(i);
    const checked = c.syncTarget && c.on && !isSrc;
    const role = !c.on ? 'off' : isSrc ? 'src' : c.syncTarget ? 'tgt' : 'off';
    const roleLabel = !c.on ? 'Offline' : isSrc ? 'Source' : c.syncTarget ? 'Target' : 'Skip';
    return `<div class="st-item ${c.on && c.syncTarget ? 'active' : ''}" style="--c:${color}">
      <div class="st-dot" style="background:${c.on ? color : 'var(--text-3)'}"></div>
      <span class="st-name">${c.name}</span>
      <span class="st-role ${role}">${roleLabel}</span>
      ${c.on && !isSrc ? `<div class="st-check ${c.syncTarget?'checked':''}" onclick="toggleSyncTarget(${i})">
        <input type="checkbox" ${c.syncTarget?'checked':''}></div>` : ''}
    </div>`;
  }).join('');
}

// ── Rename camera ────────────────────────────────────────────────────────────
function startRename(i) {
  const el = $(`cname-${i}`);
  if (!el) return;
  const current = cams[i].name;
  el.outerHTML = `<input class="cam-name-input" id="cname-input-${i}" value="${current}" onblur="finishRename(${i})" onkeydown="if(event.key==='Enter')this.blur();if(event.key==='Escape'){this.value='${current}';this.blur();}">`;
  const input = $(`cname-input-${i}`);
  input.focus();
  input.select();
}

function finishRename(i) {
  const input = $(`cname-input-${i}`);
  if (!input) return;
  const val = input.value.trim();
  if (val) cams[i].name = val;
  render();
  persistLayout();
}

// ── Camera actions ───────────────────────────────────────────────────────────
async function connect(i) {
  const ip = $(`ip-${i}`).value.trim();
  const username = $(`user-${i}`)?.value.trim() || cams[i].username;
  const password = $(`pass-${i}`)?.value.trim() || cams[i].password;

  if (!ip) { toast('Enter IP address','warn'); return; }

  // Save credentials
  cams[i].username = username;
  cams[i].password = password;

  const auth = (username && password) ? { username, password } : null;
  toast(`Connecting to ${ip}…`);

  try {
    const r = await window.ptz.connect(ip, auth);

    if (r.success) {
      cams[i].ip = ip; cams[i].on = true; cams[i].info = r.info; cams[i].cfg = r.config; cams[i].syncTarget = true;
      if (srcIdx < 0) { srcIdx = i; loadSidebarFromCfg(r.config); }
      toast(`${cams[i].name} connected`,'ok');
      render(); startSnapshot(i); persistLayout();
    } else {
      toast(`Failed: ${r.error}`,'err');
    }
  } catch (err) {
    toast(`Error: ${err.message}`,'err');
  }
}

function disconnect(i) {
  stopSnapshot(cams[i].id);
  stopTracking(cams[i].id);
  cams[i].on = false; cams[i].cfg = {}; cams[i].info = null;
  if (expandedIdx === i) expandedIdx = -1;
  if (srcIdx === i) { srcIdx = cams.findIndex(c=>c.on); if (srcIdx>=0) loadSidebarFromCfg(cams[srcIdx].cfg); }
  toast(`${cams[i].name} disconnected`); render(); persistLayout();
}

function setSource(i) { srcIdx = i; loadSidebarFromCfg(cams[i].cfg); toast(`${cams[i].name} → source`,'ok'); render(); }

function toggleExpand(i) {
  if (!cams[i].on) return;
  expandedIdx = expandedIdx === i ? -1 : i;
  render();
  if (expandedIdx === i) startSnapshot(i);
}

// ── Auth helper ──────────────────────────────────────────────────────────────
function getAuth(i) {
  const c = cams[i];
  return (c.username && c.password) ? { username: c.username, password: c.password } : null;
}

// ── PTZ / Zoom / Focus ───────────────────────────────────────────────────────
function ptzCmd(i, cmd) { const spd = $(`ptz-spd-${i}`)?.value || 8; window.ptz.ptz(cams[i].ip, cmd, spd, spd, getAuth(i)); }
function zoomCmd(i, dir) { window.ptz.zoom(cams[i].ip, dir, 3, getAuth(i)); }
function focusCmd(i, cmd) { window.ptz.focus(cams[i].ip, cmd, getAuth(i)); }
function setFocusMode(i, val) { window.ptz.setImageValue(cams[i].ip, 'focusmode', val, getAuth(i)); cams[i].cfg.focus_mode = Number(val); }

// ── Per-camera setting changes (G3 API: post_image_value) ────────────────────
// Maps UI/cfg key names → G3 API parameter names for writing
const API_PARAM = {
  wb_mode:'wbmode', red_gain:'rgain', blue_gain:'bgain', rgaintuning:'rgaintuning', bgaintuning:'bgaintuning',
  bright:'luminance', luminance:'luminance', saturation:'saturation', contrast:'contrast', hue:'hue', sharpness:'sharpness',
  exposure_mode:'aemode', aemode:'aemode', backlight:'backlight', anti_flicker:'antiflicker', antiflicker:'antiflicker',
  gain:'gain', gainLimit:'gainLimit', iris:'iris', shutter:'shutter', drc:'drc',
  nr2d:'noise2d', noise2d:'noise2d', wdr_mode:'drc',
  scene_mode:'scene', focusmode:'focusmode', colortemp:'colortemp',
  expcomp_mode:'expcomp_mode', expcomp_level:'expcomp_level', meter:'meter'
};
function setCamImg(i, k, v) {
  const apiKey = API_PARAM[k] || k;
  window.ptz.setImageValue(cams[i].ip, apiKey, v, getAuth(i));
  cams[i].cfg[k] = Number(v);
}
function setCamExp(i, k, v) {
  const apiKey = API_PARAM[k] || k;
  window.ptz.setImageValue(cams[i].ip, apiKey, v, getAuth(i));
  cams[i].cfg[k] = Number(v);
}

// ── Snapshot feed ────────────────────────────────────────────────────────────
function startSnapshot(i) {
  const camId = cams[i]?.id; if (camId == null) return;
  stopSnapshot(camId);
  let frame = 0, t0 = Date.now(), fails = 0;
  async function grab() {
    if (!cams[i] || !cams[i].on) {
      return;
    }
    const r = await window.ptz.snapshot(cams[i].ip, getAuth(i));
    const img = $(`vf-img-${i}`), ph = $(`vf-ph-${i}`), fps = $(`vf-fps-${i}`);
    if (r.success && img) {
      const mime = r.mime || 'image/jpeg';
      img.src = `data:${mime};base64,` + r.data;
      img.style.display = 'block';
      if (ph) ph.style.display = 'none';
      frame++;
      fails = 0;
      const elapsed = (Date.now() - t0) / 1000;
      if (fps && elapsed > 0) fps.textContent = (frame / elapsed).toFixed(1) + ' fps';
    } else {
      fails++;
      if (ph) ph.textContent = 'Snapshot failed: ' + (r.error || 'unknown');
    }
    // Back off on repeated failures: 250ms → 500ms → 1s → 2s → 4s (max)
    const delay = fails > 0 ? Math.min(4000, 250 * Math.pow(2, fails)) : 250;
    snapshotTimers[camId] = setTimeout(grab, delay);
  }
  grab();
}

function stopSnapshot(camId) { if (snapshotTimers[camId]) { clearTimeout(snapshotTimers[camId]); delete snapshotTimers[camId]; } }

// ── AI Smart Tracking ────────────────────────────────────────────────────────

// Shot profiles: each defines framing target and zoom range
const SHOT_PROFILES = {
  wide: {
    label: 'Wide',
    // Generous framing — full upper body, lots of context
    framingY: 0.50,        // center of frame vertically
    deadzoneX: 0.18,       // wide deadzone — tolerant of movement
    deadzoneY: 0.18,
    zoomIn: 0.30,          // zoom in if subject < 30% of frame
    zoomOut: 0.50,         // zoom out if subject > 50%
    zoomDead: 0.05,
    maxSpeed: 5,
  },
  medium: {
    label: 'Medium',
    // Balanced waist-up with moderate headroom
    framingY: 0.40,        // slightly above center
    deadzoneX: 0.15,
    deadzoneY: 0.15,
    zoomIn: 0.50,
    zoomOut: 0.72,
    zoomDead: 0.04,
    maxSpeed: 6,
  },
  tight: {
    label: 'Tight',
    // Tight waist-up profile — like the reference screenshot
    // Subject fills ~85% of frame, minimal headroom, cut at waist
    framingY: 0.36,        // higher framing — less headroom
    deadzoneX: 0.12,       // tighter deadzone — more responsive
    deadzoneY: 0.10,
    zoomIn: 0.65,          // zoom in aggressively if subject < 65%
    zoomOut: 0.88,         // only zoom out if really filling frame
    zoomDead: 0.03,
    maxSpeed: 6,
  },
};

let cocoModel = null;
let moveNetModel = null;
// Per-camera tracking state: last known direction, speed, lost frame count
const trackState = {};

function toggleTracking(i) {
  cams[i].tracking = !cams[i].tracking;
  render();
  if (cams[i].tracking) {
    startTracking(i);
  } else {
    stopTracking(cams[i].id);
    window.ptz.ptz(cams[i].ip, 'ptzstop', 0, 0, getAuth(i));
  }
}

function setTrackModel(i, model) {
  cams[i].trackModel = model;
  if (cams[i].tracking) {
    stopTracking(cams[i].id);
    startTracking(i);
  }
}

function setShotProfile(i, profile) {
  cams[i].shotProfile = profile;
}

function stopTracking(camId) {
  if (trackTimers[camId]) { clearTimeout(trackTimers[camId]); delete trackTimers[camId]; }
  delete trackState[camId];
  const cam = cams.find(c => c.id === camId);
  if (cam) cam.tracking = false;
}

async function startTracking(i) {
  const camId = cams[i].id;
  const modelType = cams[i].trackModel || 'coco';
  stopTracking(camId);
  cams[i].tracking = true;
  trackState[camId] = { lastCmd: null, lastSpeed: 0, lostFrames: 0, lastDx: 0, lastDy: 0, lastCx: null, lastCy: null, moving: false, smoothSpeed: 0, zooming: false, subjectSize: 0 };

  // Update status text directly — avoid render() which would recreate DOM mid-load
  const statEl = $(`trk-stat-${i}`);
  if (statEl) statEl.textContent = 'Loading AI model…';

  try {
    if (modelType === 'movenet') {
      if (!moveNetModel) {
        moveNetModel = await poseDetection.createDetector(
          poseDetection.SupportedModels.MoveNet,
          { modelType: 'SinglePose.Lightning', runtime: 'tfjs', modelUrl: '../vendor/models/movenet/model.json' }
        );
        toast('MoveNet Lightning loaded', 'ok');
      }
    } else {
      if (!cocoModel) {
        cocoModel = await cocoSsd.load({ base: 'lite_mobilenet_v2' });
        toast('COCO-SSD loaded', 'ok');
      }
    }
  } catch (e) {
    toast('Failed to load AI model', 'err');
    cams[i].tracking = false;
    render();
    return;
  }

  // Re-verify camera is still present and tracking after async model load
  if (!cams[i] || cams[i].id !== camId || !cams[i].tracking) return;

  const MAX_PURSUIT_FRAMES = 8; // Shorter pursuit — stop sooner to avoid overshooting

  // Use a canvas to feed TF.js — avoids cross-origin/tainted-canvas issues with <img>
  const trackCanvas = document.createElement('canvas');
  const trackCtx = trackCanvas.getContext('2d');

  async function loop() {
    // Guard against camera removal/reorder using id, not index
    if (!cams[i] || cams[i].id !== camId || !cams[i].tracking || !cams[i].on) return;

    const img = $(`vf-img-${i}`);
    const statEl = $(`trk-stat-${i}`);
    const dotEl = $(`trk-dot-${i}`);
    const st = trackState[camId];

    if (img && img.complete && img.naturalWidth > 0) {
      try {
        const imgW = img.naturalWidth;
        const imgH = img.naturalHeight;

        // Draw to canvas for TF.js (avoids any img element pixel-read issues)
        if (trackCanvas.width !== imgW || trackCanvas.height !== imgH) {
          trackCanvas.width = imgW;
          trackCanvas.height = imgH;
        }
        trackCtx.drawImage(img, 0, 0);

        let cx = null, cy = null;
        let subjectSizeRatio = 0; // subject height as fraction of frame height

        if (modelType === 'movenet' && moveNetModel) {
          const poses = await moveNetModel.estimatePoses(trackCanvas);
          const validPoses = poses.filter(p => {
            const k = p.keypoints;
            return k[0].score > 0.3 || k[5].score > 0.3 || k[6].score > 0.3;
          });

          if (validPoses.length > 0) {
            let target = validPoses[0];

            // Persistence: Find pose closest to last known position
            if (st.lastCx !== null && st.lastCy !== null) {
              const getCentroid = (p) => {
                const k = p.keypoints;
                let x=0, y=0, n=0;
                [0, 5, 6].forEach(idx => {
                  if (k[idx].score > 0.3) { x+=k[idx].x; y+=k[idx].y; n++; }
                });
                return n > 0 ? {x:x/n, y:y/n} : {x:st.lastCx, y:st.lastCy};
              };

              target = validPoses.reduce((closest, curr) => {
                const cC = getCentroid(closest);
                const pC = getCentroid(curr);
                const distClosest = Math.hypot(cC.x - st.lastCx, cC.y - st.lastCy);
                const distCurr = Math.hypot(pC.x - st.lastCx, pC.y - st.lastCy);
                return distCurr < distClosest ? curr : closest;
              });
            }

            const kps = target.keypoints;
            const nose = kps[0];  // 0
            const lS = kps[5];    // left shoulder
            const rS = kps[6];    // right shoulder
            const lH = kps[11];   // left hip
            const rH = kps[12];   // right hip

            // Tracking point: center on chest area (between shoulders and hips)
            // This naturally reduces headroom compared to nose-weighted centroid
            let xSum = 0, ySum = 0, div = 0;
            if (nose.score > 0.3)  { xSum += nose.x; ySum += nose.y; div += 1; }
            if (lS.score > 0.3)    { xSum += lS.x;   ySum += lS.y;   div += 1; }
            if (rS.score > 0.3)    { xSum += rS.x;   ySum += rS.y;   div += 1; }
            // Include hips if visible — pulls centroid down for better framing
            if (lH.score > 0.25)   { xSum += lH.x;   ySum += lH.y;   div += 1; }
            if (rH.score > 0.25)   { xSum += rH.x;   ySum += rH.y;   div += 1; }

            if (div > 0) {
              cx = xSum / div;
              cy = ySum / div;
              st.lastCx = cx;
              st.lastCy = cy;
            }

            // Estimate subject size: vertical span from top keypoint to bottom keypoint
            const visibleY = kps.filter(k => k.score > 0.25).map(k => k.y);
            if (visibleY.length >= 2) {
              const span = Math.max(...visibleY) - Math.min(...visibleY);
              subjectSizeRatio = span / imgH;
            }
          }
        } else if (cocoModel) {
          const predictions = await cocoModel.detect(trackCanvas);
          const people = predictions.filter(p => p.class === 'person' && p.score > 0.4);

          if (people.length > 0) {
            let target = people[0];

            if (st.lastCx !== null && st.lastCy !== null) {
              target = people.reduce((closest, curr) => {
                const [bx, by, bw, bh] = closest.bbox;
                const [nx, ny, nw, nh] = curr.bbox;
                const distClosest = Math.hypot((bx + bw/2) - st.lastCx, (by + bh/2) - st.lastCy);
                const distCurr = Math.hypot((nx + nw/2) - st.lastCx, (ny + nh/2) - st.lastCy);
                return distCurr < distClosest ? curr : closest;
              });
            }

            const [x, y, w, h] = target.bbox;
            cx = x + w / 2;
            cy = y + h / 2;
            st.lastCx = cx;
            st.lastCy = cy;
            subjectSizeRatio = h / imgH;
          }
        }

        if (cx !== null) {
          st.lostFrames = 0;
          const prof = SHOT_PROFILES[cams[i].shotProfile] || SHOT_PROFILES.tight;
          const dx = cx - imgW / 2;
          const dy = cy - imgH * prof.framingY;
          st.lastDx = dx;
          st.lastDy = dy;
          const sizeLabel = subjectSizeRatio > 0 ? ` · ${(subjectSizeRatio*100).toFixed(0)}%` : '';
          if (statEl) statEl.textContent = `Tracking · Δx${Math.round(dx)} Δy${Math.round(dy)}${sizeLabel}`;
          if (dotEl) dotEl.className = 'track-dot active';

          const deadzoneX = imgW * prof.deadzoneX;
          const deadzoneY = imgH * prof.deadzoneY;
          const xOut = Math.abs(dx) > deadzoneX;
          const yOut = Math.abs(dy) > deadzoneY;

          if (xOut || yOut) {
            let cmd;
            if (xOut && yOut) {
              cmd = (dy > 0 ? 'down' : 'up') + (dx > 0 ? 'right' : 'left');
            } else if (xOut) {
              cmd = dx > 0 ? 'right' : 'left';
            } else {
              cmd = dy > 0 ? 'down' : 'up';
            }

            // Gentle proportional speed based on profile
            const errX = xOut ? (Math.abs(dx) - deadzoneX) / (imgW / 2 - deadzoneX) : 0;
            const errY = yOut ? (Math.abs(dy) - deadzoneY) / (imgH / 2 - deadzoneY) : 0;
            const errNorm = Math.max(errX, errY); // 0..1 how far past deadzone
            const targetSpeed = Math.min(prof.maxSpeed, Math.max(1, Math.round(1 + errNorm * (prof.maxSpeed - 1))));

            // Smooth acceleration — ramp up gradually, never jump speed
            st.smoothSpeed = st.smoothSpeed + (targetSpeed - st.smoothSpeed) * 0.3;
            const speed = Math.max(1, Math.round(st.smoothSpeed));

            console.log(`[tracking] PTZ cmd=${cmd} speed=${speed} (target=${targetSpeed}) dx=${Math.round(dx)} dy=${Math.round(dy)}`);
            st.lastCmd = cmd;
            st.lastSpeed = speed;
            st.moving = true;
            const ptzResult = await window.ptz.ptz(cams[i].ip, cmd, speed, speed, getAuth(i));
            if (!ptzResult.success) console.error('[tracking] PTZ command failed:', ptzResult.error);
          } else {
            // Subject is centered — stop smoothly
            if (st.moving) {
              st.smoothSpeed = 0;
              st.moving = false;
              await window.ptz.ptz(cams[i].ip, 'ptzstop', 0, 0, getAuth(i));
            }
            st.lastCmd = null;
            st.lastSpeed = 0;
          }

          // ── Gentle auto-zoom to keep subject well-framed ──
          // Only zoom when pan/tilt is settled (not moving) to avoid compounding
          if (subjectSizeRatio > 0 && !st.moving) {
            if (subjectSizeRatio < prof.zoomIn - prof.zoomDead && !st.zooming) {
              st.zooming = true;
              console.log(`[tracking] Zoom in — subject=${(subjectSizeRatio*100).toFixed(0)}% (target ${(prof.zoomIn*100).toFixed(0)}-${(prof.zoomOut*100).toFixed(0)}%)`);
              await window.ptz.zoom(cams[i].ip, 'zoomin', 1, getAuth(i));
            } else if (subjectSizeRatio > prof.zoomOut + prof.zoomDead && !st.zooming) {
              st.zooming = true;
              console.log(`[tracking] Zoom out — subject=${(subjectSizeRatio*100).toFixed(0)}% (target ${(prof.zoomIn*100).toFixed(0)}-${(prof.zoomOut*100).toFixed(0)}%)`);
              await window.ptz.zoom(cams[i].ip, 'zoomout', 1, getAuth(i));
            } else if (subjectSizeRatio >= prof.zoomIn && subjectSizeRatio <= prof.zoomOut) {
              if (st.zooming) {
                st.zooming = false;
                await window.ptz.zoom(cams[i].ip, 'zoomstop', 0, getAuth(i));
              }
            }
          } else if (st.zooming && st.moving) {
            // Stop zoom while panning to prevent compounding
            st.zooming = false;
            await window.ptz.zoom(cams[i].ip, 'zoomstop', 0, getAuth(i));
          }
        } else {
          st.lostFrames++;
          // Stop zoom on subject loss
          if (st.zooming) {
            st.zooming = false;
            await window.ptz.zoom(cams[i].ip, 'zoomstop', 0, getAuth(i));
          }
          if (st.lastCmd && st.lostFrames <= MAX_PURSUIT_FRAMES) {
            // Gentle pursuit: start at speed 2, decay to 1
            const decaySpeed = Math.max(1, Math.min(2, Math.ceil(st.lastSpeed * (1 - st.lostFrames / MAX_PURSUIT_FRAMES))));
            if (statEl) statEl.textContent = `Pursuing… (${MAX_PURSUIT_FRAMES - st.lostFrames})`;
            if (dotEl) dotEl.className = 'track-dot lost';
            await window.ptz.ptz(cams[i].ip, st.lastCmd, decaySpeed, decaySpeed, getAuth(i));
          } else {
            if (st.moving) {
              st.moving = false;
              await window.ptz.ptz(cams[i].ip, 'ptzstop', 0, 0, getAuth(i));
            }
            if (statEl) statEl.textContent = 'Subject lost — waiting…';
            if (dotEl) dotEl.className = 'track-dot lost';
          }
        }
      } catch (err) {
        console.error('[tracking] loop error:', err);
        if (statEl) statEl.textContent = 'Detection error — check console';
        if (dotEl) dotEl.className = 'track-dot lost';
      }
    } else {
      console.log('[tracking] No image ready:', img ? `complete=${img.complete} naturalWidth=${img.naturalWidth}` : 'img element missing');
      if (statEl) statEl.textContent = 'Waiting for snapshot feed…';
    }
    trackTimers[camId] = setTimeout(loop, 300);
  }
  loop();
}

// ── Native Camera Auto-Tracking ──────────────────────────────────────────────
async function toggleNativeTracking(i) {
  const c = cams[i];
  const enabling = !c.nativeTracking;
  const btn = $(`vf-nat-${i}`);
  if (btn) btn.textContent = enabling ? 'Turning on…' : 'Turning off…';
  const r = await window.ptz.setAutoTracking(c.ip, enabling, getAuth(i));
  if (r.success) {
    c.nativeTracking = enabling;
    toast(`Native auto-tracking ${enabling ? 'enabled' : 'disabled'}`, 'ok');
    if (btn) { btn.className = 'vf-action-btn' + (enabling ? ' active' : ''); btn.innerHTML = `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12h5M17 12h5M12 2v5M12 17v5"/><circle cx="12" cy="12" r="3"/></svg> ${enabling ? 'AT On' : 'AT Off'}`; }
  } else {
    toast('Auto-tracking: ' + (r.error || 'failed'), 'err');
    if (btn) btn.innerHTML = `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12h5M17 12h5M12 2v5M12 17v5"/><circle cx="12" cy="12" r="3"/></svg> ${c.nativeTracking ? 'AT On' : 'AT Off'}`;
  }
}

// ── Snapshot Download ────────────────────────────────────────────────────────
async function takeSnapshot(i) {
  const c = cams[i];
  toast('Capturing snapshot…');
  const r = await window.ptz.saveSnapshot(c.ip, getAuth(i));
  if (r.success) {
    const link = document.createElement('a');
    const ts = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
    link.download = `${c.name || 'camera'}-${ts}.jpg`;
    link.href = `data:${r.mime || 'image/jpeg'};base64,${r.data}`;
    link.click();
    toast('Snapshot saved', 'ok');
  } else {
    toast('Snapshot failed: ' + (r.error || 'unknown'), 'err');
  }
}

// ── Intelligent White Balance ────────────────────────────────────────────────
async function analyzeWB(i) {
  const img = $(`vf-img-${i}`);
  if (!img || !img.src || img.style.display === 'none') { toast('No feed — connect camera first', 'warn'); return; }
  toast('Analyzing white balance…');

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  canvas.width = img.naturalWidth || 320;
  canvas.height = img.naturalHeight || 240;
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  const x0 = Math.floor(canvas.width * 0.2), y0 = Math.floor(canvas.height * 0.2);
  const w = Math.floor(canvas.width * 0.6), h = Math.floor(canvas.height * 0.6);
  const data = ctx.getImageData(x0, y0, w, h).data;

  let rSum = 0, gSum = 0, bSum = 0, count = 0;
  for (let px = 0; px < data.length; px += 4) {
    const r = data[px], g = data[px+1], b = data[px+2];
    const lum = 0.299*r + 0.587*g + 0.114*b;
    if (lum > 20 && lum < 235) { rSum += r; gSum += g; bSum += b; count++; }
  }

  if (count < 100) { toast('Not enough data', 'warn'); return; }

  const rAvg = rSum / count, gAvg = gSum / count, bAvg = bSum / count;
  const X = 0.4124*rAvg + 0.3576*gAvg + 0.1805*bAvg;
  const Y = 0.2126*rAvg + 0.7152*gAvg + 0.0722*bAvg;
  const Z = 0.0193*rAvg + 0.1192*gAvg + 0.9505*bAvg;
  const sum = X + Y + Z;
  const cx = sum > 0 ? X / sum : 0.3127, cy = sum > 0 ? Y / sum : 0.3290;
  const n = (cx - 0.3320) / (0.1858 - cy);
  let cct = Math.round(449*n*n*n + 3525*n*n + 6823.3*n + 5520.33);
  cct = Math.max(2000, Math.min(12000, cct));

  const neutral = (rAvg + gAvg + bAvg) / 3;
  const redShift = Math.round(((rAvg - neutral) / neutral) * 100);
  const blueShift = Math.round(((bAvg - neutral) / neutral) * 100);

  const tempEl = $(`iwb-temp-${i}`);
  tempEl.textContent = cct + 'K';
  tempEl.className = 'num ' + (cct < 4200 ? 'warm' : cct > 6200 ? 'cool' : 'ok');
  $(`iwb-rshift-${i}`).textContent = (redShift > 0 ? '+' : '') + redShift + '%';
  $(`iwb-bshift-${i}`).textContent = (blueShift > 0 ? '+' : '') + blueShift + '%';

  const wbBadge = $(`vf-wb-${i}`);
  if (wbBadge) { wbBadge.textContent = cct + 'K'; wbBadge.className = 'vf-wb-badge ' + (cct < 4200 ? 'warm' : cct > 6200 ? 'cool' : 'ok'); }

  const sugEl = $(`iwb-sug-${i}`);
  const currentRed = cams[i].cfg.red_gain ?? cams[i].cfg.rgain ?? 128, currentBlue = cams[i].cfg.blue_gain ?? cams[i].cfg.bgain ?? 128;

  if (Math.abs(redShift) <= 3 && Math.abs(blueShift) <= 3) {
    sugEl.innerHTML = `<div class="iwb-suggestion good"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>White balance looks neutral</div>`;
  } else {
    const redAdj = Math.round(-redShift * 0.8), blueAdj = Math.round(-blueShift * 0.8);
    const newRed = Math.max(0, Math.min(255, currentRed + redAdj));
    const newBlue = Math.max(0, Math.min(255, currentBlue + blueAdj));
    sugEl.innerHTML = `<div class="iwb-suggestion adjust">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink:0"><path d="M12 9v4M12 17h.01"/><circle cx="12" cy="12" r="10"/></svg>
      <div>${cct<4500?'Warm':'Cool'} cast. Red ${newRed} (${redAdj>0?'+':''}${redAdj}), Blue ${newBlue} (${blueAdj>0?'+':''}${blueAdj})
      <button class="btn btn-xs btn-accent" style="margin-left:6px" onclick="applyWBSuggestion(${i},${newRed},${newBlue})">Apply</button>
      <button class="btn btn-xs" style="margin-left:3px" onclick="applyWBToSelected(${newRed},${newBlue})">Apply to Selected</button></div></div>`;
  }
  toast('WB analysis complete', 'ok');
}

function applyWBSuggestion(i, red, blue) {
  // Manual WB mode=5, then set rgain/bgain (0-255)
  window.ptz.setImageValue(cams[i].ip, 'wbmode', 5, getAuth(i));
  window.ptz.setImageValue(cams[i].ip, 'rgain', red, getAuth(i));
  window.ptz.setImageValue(cams[i].ip, 'bgain', blue, getAuth(i));
  cams[i].cfg.wb_mode = 5; cams[i].cfg.rgain = red; cams[i].cfg.bgain = blue;
  toast(`Applied WB to ${cams[i].name}`, 'ok'); render();
}

function applyWBToSelected(red, blue) {
  let n = 0;
  cams.forEach((c, i) => {
    if (!c.on || !c.syncTarget || i === srcIdx) return;
    window.ptz.setImageValue(c.ip, 'wbmode', 5, getAuth(i));
    window.ptz.setImageValue(c.ip, 'rgain', red, getAuth(i));
    window.ptz.setImageValue(c.ip, 'bgain', blue, getAuth(i));
    c.cfg.wb_mode = 5; c.cfg.rgain = red; c.cfg.bgain = blue; n++;
  });
  // Also apply to source
  if (srcIdx >= 0 && cams[srcIdx]?.on) {
    window.ptz.setImageValue(cams[srcIdx].ip, 'wbmode', 5, getAuth(srcIdx));
    window.ptz.setImageValue(cams[srcIdx].ip, 'rgain', red, getAuth(srcIdx));
    window.ptz.setImageValue(cams[srcIdx].ip, 'bgain', blue, getAuth(srcIdx));
    cams[srcIdx].cfg.wb_mode = 5; cams[srcIdx].cfg.rgain = red; cams[srcIdx].cfg.bgain = blue;
  }
  $('s-wb').value = '5'; $('s-rg-wrap').style.display = 'none'; $('s-bg-wrap').style.display = 'none';
  toast(`Applied WB to ${n + 1} cameras`, 'ok'); render();
}

// ── Sidebar: load from source ────────────────────────────────────────────────
function loadSidebarFromCfg(cfg) {
  if (cfg.wb_mode !== undefined) $('s-wb').value = cfg.wb_mode;
  const wbv = $('s-wb').value;
  const showTuning = ['0','3','32'].includes(wbv);
  $('s-rg-wrap').style.display = showTuning ? 'block' : 'none';
  $('s-bg-wrap').style.display = showTuning ? 'block' : 'none';
  const map = [['s-rg','rgaintuning'],['s-bg','bgaintuning'],['s-sat','saturation'],['s-brt','bright'],['s-con','contrast'],['s-hue','hue'],['s-shp','sharpness'],['s-gain','gain'],['s-gainlimit','gainLimit'],['s-iris','iris'],['s-shutter','shutter'],['s-nr2d','nr2d'],['s-drc','drc']];
  for (const [id,key] of map) { if (cfg[key]!==undefined) { $(id).value = cfg[key]; $(`${id}-v`).textContent = cfg[key]; } }
  if (cfg.exposure_mode !== undefined) $('s-exp').value = cfg.exposure_mode;
  if (cfg.backlight !== undefined) $('s-bl').value = cfg.backlight;
}

// ── Selective Sync ───────────────────────────────────────────────────────────
async function syncSelected() {
  const btn = $('sync-btn');
  btn.classList.add('syncing');

  // Use G3 API param names for writing to camera
  const imgParams = {
    wbmode: $('s-wb').value, rgaintuning: $('s-rg').value, bgaintuning: $('s-bg').value,
    saturation: $('s-sat').value, luminance: $('s-brt').value,
    contrast: $('s-con').value, hue: $('s-hue').value,
    sharpness: $('s-shp').value, noise2d: $('s-nr2d').value
  };
  const expParams = {
    aemode: $('s-exp').value, gain: $('s-gain').value, gainLimit: $('s-gainlimit').value,
    backlight: $('s-bl').value, iris: $('s-iris').value, shutter: $('s-shutter').value,
    drc: $('s-drc').value
  };

  let ok = 0;
  for (let i = 0; i < cams.length; i++) {
    const c = cams[i];
    // Only sync to connected targets (not source unless also target)
    if (!c.on) continue;
    if (i === srcIdx || c.syncTarget) {
      const r = await window.ptz.syncAll(c.ip, imgParams, expParams, {}, getAuth(i));
      if (r.success) ok++;
    }
  }

  // Refresh
  for (let i = 0; i < cams.length; i++) {
    const c = cams[i];
    if (!c.on) continue;
    const r = await window.ptz.getSettings(c.ip, getAuth(i));
    if (r.success) c.cfg = r.config;
  }

  btn.classList.remove('syncing');
  render();
  toast(`Synced to ${ok} camera${ok!==1?'s':''}`, 'ok');
}

// ── Refresh / Discover ───────────────────────────────────────────────────────
async function refreshAll() {
  let n = 0;
  for (let i = 0; i < cams.length; i++) {
    const c = cams[i];
    if (!c.on) continue;
    const r = await window.ptz.getSettings(c.ip, getAuth(i));
    if (r.success) { c.cfg = r.config; n++; }
    else { c.on = false; toast(`Lost ${c.name}`, 'err'); }
  }
  if (srcIdx >= 0 && cams[srcIdx]?.on) loadSidebarFromCfg(cams[srcIdx].cfg);
  render(); toast(n ? `Refreshed ${n}` : 'No cameras', n ? 'ok' : 'warn');
}

async function discover() {
  toast('Scanning…');
  const f = await window.ptz.discover();
  if (f.length) {
    let added = 0;
    f.forEach(d => {
      // Skip if this IP is already in the camera list
      if (cams.some(c => c.ip === d.ip)) return;
      const emptySlot = cams.findIndex(c => !c.on && !c.ip);
      if (emptySlot >= 0) { cams[emptySlot].ip = d.ip; }
      else { addCamera(d.ip); }
      added++;
    });
    render();
    if (added > 0) toast(`Found ${added} new device${added>1?'s':''}`, 'ok');
    else toast(`${f.length} device${f.length>1?'s':''} found (already added)`, 'ok');
  } else toast('None found — enter IPs manually','warn');
}

// ── Globals ──────────────────────────────────────────────────────────────────
function updateGlobals() {
  const on = cams.filter(c=>c.on);
  const targets = cams.filter((c, i) => c.on && c.syncTarget && i !== srcIdx);
  $('cnt').textContent = `${on.length} connected`;
  $('cnt').className = on.length ? 'badge' : 'badge warn';
  $('src-lbl').textContent = srcIdx >= 0 ? cams[srcIdx].name : 'None';

  // Sync button state
  const canSync = on.length >= 1 && srcIdx >= 0 && cams[srcIdx]?.on;
  $('sync-btn').disabled = !canSync;

  // Dynamic sync button label
  if (targets.length > 0) {
    $('sync-btn-label').textContent = `Sync to ${targets.length} Camera${targets.length>1?'s':''}`;
  } else if (canSync) {
    $('sync-btn-label').textContent = 'Sync Source Only';
  } else {
    $('sync-btn-label').textContent = 'Sync to Selected';
  }

  const dot = $('s-dot'), st = $('s-status');
  if (!on.length) { dot.className='status-dot'; st.textContent='No cameras connected'; }
  else if (srcIdx<0) { dot.className='status-dot warn'; st.textContent=`${on.length} connected — select source`; }
  else {
    dot.className='status-dot ok';
    st.textContent = targets.length > 0
      ? `${cams[srcIdx].name} → ${targets.map(c=>c.name).join(', ')}`
      : `Source: ${cams[srcIdx].name} (no targets selected)`;
  }

  // Mismatch bar
  const keys = ['wb_mode','rgaintuning','bgaintuning','saturation','bright','contrast','hue','sharpness'];
  const mm = keys.filter(k => { const v = on.map(c=>c.cfg[k]); return v.length>1 && !v.every(x=>x===v[0]); });
  const bar = $('mm-bar');
  if (mm.length && on.length > 1) { bar.classList.add('vis'); $('mm-txt').textContent = `${mm.length} setting${mm.length>1?'s differ':' differs'} — sync to match`; }
  else bar.classList.remove('vis');
}

// ── Persist layout ───────────────────────────────────────────────────────────
function persistLayout() {
  const data = cams.map(c => ({ ip: c.ip, name: c.name, username: c.username, password: c.password }));
  localStorage.setItem('ptz_layout', JSON.stringify(data));
}

function loadLayout() {
  try {
    const data = JSON.parse(localStorage.getItem('ptz_layout') || '[]');
    if (data.length > 0) {
      cams = [];
      data.forEach(d => cams.push(makeCam(d.ip, d.name, d.username || 'admin', d.password || 'admin')));
      render();
    }
  } catch {}
}

// ── Toast ────────────────────────────────────────────────────────────────────
function toast(msg, type='') {
  const el = document.createElement('div');
  el.className = `toast ${type}`; el.textContent = msg;
  $('toasts').appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// ── Keyboard Control ─────────────────────────────────────────────────────────
document.addEventListener('keydown', (e) => {
  if (expandedIdx < 0 || !cams[expandedIdx]?.on) return;
  if (e.repeat || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
  let cmd = null;
  let zCmd = null;
  let fCmd = null;
  switch (e.key) {
    case 'ArrowUp': cmd = 'up'; break;
    case 'ArrowDown': cmd = 'down'; break;
    case 'ArrowLeft': cmd = 'left'; break;
    case 'ArrowRight': cmd = 'right'; break;
    case 'Home': cmd = 'home'; break;
    case '+': case '=': zCmd = 'zoomin'; break;
    case '-': case '_': zCmd = 'zoomout'; break;
    case 'f': case 'F': fCmd = 'focusout'; break;
    case 'n': case 'N': fCmd = 'focusin'; break;
  }
  if (cmd) {
    e.preventDefault();
    ptzCmd(expandedIdx, cmd);
    const btn = document.querySelector(`.cam[data-i="${expandedIdx}"] .joy-btn.${cmd}`);
    if (btn) btn.classList.add('active');
  } else if (zCmd) {
    e.preventDefault(); zoomCmd(expandedIdx, zCmd);
    const btn = document.querySelector(`.cam[data-i="${expandedIdx}"] .btn-${zCmd === 'zoomin' ? 'zoom-in' : 'zoom-out'}`);
    if (btn) btn.classList.add('active');
  } else if (fCmd) {
    e.preventDefault(); focusCmd(expandedIdx, fCmd);
    const btn = document.querySelector(`.cam[data-i="${expandedIdx}"] .btn-${fCmd === 'focusin' ? 'focus-in' : 'focus-out'}`);
    if (btn) btn.classList.add('active');
  }
});

document.addEventListener('keyup', (e) => {
  if (expandedIdx < 0 || !cams[expandedIdx]?.on) return;
  const map = { 'ArrowUp': 'up', 'ArrowDown': 'down', 'ArrowLeft': 'left', 'ArrowRight': 'right', 'Home': 'home' };
  const cmd = map[e.key];
  if (cmd) {
    if (cmd !== 'home') ptzCmd(expandedIdx, 'ptzstop');
    const btn = document.querySelector(`.cam[data-i="${expandedIdx}"] .joy-btn.${cmd}`);
    if (btn) btn.classList.remove('active');
  } else if (['+', '=', '-', '_'].includes(e.key)) {
    zoomCmd(expandedIdx, 'zoomstop');
    const zCmd = ['+', '='].includes(e.key) ? 'zoomin' : 'zoomout';
    const btn = document.querySelector(`.cam[data-i="${expandedIdx}"] .btn-${zCmd === 'zoomin' ? 'zoom-in' : 'zoom-out'}`);
    if (btn) btn.classList.remove('active');
  } else if (['f', 'F', 'n', 'N'].includes(e.key)) {
    focusCmd(expandedIdx, 'focusstop');
    const fCmd = ['n', 'N'].includes(e.key) ? 'focusin' : 'focusout';
    const btn = document.querySelector(`.cam[data-i="${expandedIdx}"] .btn-${fCmd === 'focusin' ? 'focus-in' : 'focus-out'}`);
    if (btn) btn.classList.remove('active');
  }
});

// ── Init ─────────────────────────────────────────────────────────────────────
loadLayout();
const savedTheme = localStorage.getItem('ptz_theme') || 'dark';
document.documentElement.setAttribute('data-theme', savedTheme);
updateThemeIcon(savedTheme);

render();

// Auto-refresh
setInterval(async () => {
  for (let i = 0; i < cams.length; i++) {
    const c = cams[i];
    if (!c.on) continue;
    const r = await window.ptz.getSettings(c.ip, getAuth(i));
    if (r.success) c.cfg = r.config;
    else { c.on = false; stopSnapshot(c.id); stopTracking(c.id); toast(`Lost ${c.name}`,'err'); }
  }
  if (expandedIdx < 0) render();
  else { renderSyncTargets(); updateGlobals(); }
}, 12000);
</script>
</body>
</html>
